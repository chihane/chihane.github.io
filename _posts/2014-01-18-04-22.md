---
layout: post
title: 这有点爽的
date: 2014-01-18 04:22:00
categories: cnblogs
---

<p>　　简单应用了一下多线程，搞定了多客户端的问题。</p>
<p>　　之前只能有一个客户端接入，因为服务器只会accept()一次，然后就进入接收输入流的死循环了。</p>
<p>　　然后我趴在地上想了一下，主进程里死循环来accept()，然后每个客户端new一个新进程是不是就搞定了，越想越觉得有道理，于是就试了试。</p>
<p>　　另外每个进程里重新各new一个Socket和输入流，这样就不会跟主进程产生冲突，同时主进程里的这两个也就可以直接删掉了。</p>
<p>　　于是现在是各个进程各自处理自己的接收信息动作，互不干涉。</p>
<p>&nbsp;</p>
<p>　　启动进程是start()不是run()哪。</p>
<p>&nbsp;</p>
<p>　　现在的问题是服务器已经把该接收的都接收了，怎么把客户端发上来的消息再发给其他客户端呢。</p>
<p>　　不可能在服务器里放一个StringBuffer，虽然这样很稳妥，也能解决问题，但是这样消耗带宽越来越大&hellip;&hellip;</p>
<p>　　另一种方法是客户端发上来消息之后先不更新自己的文本框内容，由服务器向所有客户端来发送，也就是说我发一条消息要发上去再下下来，是不是有点蛋疼，虽然这样也可以解决问题。</p>
<p>　　</p>
<p>　　诸君，我从小学开始就最擅长找笨办法了&hellip;&hellip;</p>
<p>　　智商低好痛苦 _(:з」&ang;)_</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('c4c3c4d5-5280-4c40-ac40-b4c7aeeb3ba3')"><img id="code_img_closed_c4c3c4d5-5280-4c40-ac40-b4c7aeeb3ba3" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_c4c3c4d5-5280-4c40-ac40-b4c7aeeb3ba3" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('c4c3c4d5-5280-4c40-ac40-b4c7aeeb3ba3',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_c4c3c4d5-5280-4c40-ac40-b4c7aeeb3ba3" class="cnblogs_code_hide">
<pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">import</span> java.io.*<span style="color: #000000;">;
</span><span style="color: #008080;">  2</span> <span style="color: #0000ff;">import</span> java.net.*<span style="color: #000000;">;
</span><span style="color: #008080;">  3</span> 
<span style="color: #008080;">  4</span> <span style="color: #008000;">/**</span>
<span style="color: #008080;">  5</span> <span style="color: #008000;"> * 服务器端，目前还是单纯的解包并在命令行打印，再下个版本改。
</span><span style="color: #008080;">  6</span> <span style="color: #008000;"> * 1. 处理了端口已占用的异常。
</span><span style="color: #008080;">  7</span> <span style="color: #008000;"> * 2. 客户端退出后不关闭进程。
</span><span style="color: #008080;">  8</span> <span style="color: #008000;"> * 3. *重要内容* 改用多进程的方式，支持了多客户端接入。
</span><span style="color: #008080;">  9</span> <span style="color: #008000;"> * 不过目前只能接收信息命令行打印。
</span><span style="color: #008080;"> 10</span> <span style="color: #008000;"> * 之后加上向其他客户端发送消息的功能。
</span><span style="color: #008080;"> 11</span> <span style="color: #008000;"> * 
</span><span style="color: #008080;"> 12</span> <span style="color: #008000;"> * </span><span style="color: #808080;">@author</span><span style="color: #008000;"> mlxy
</span><span style="color: #008080;"> 13</span> <span style="color: #008000;"> * </span><span style="color: #808080;">@version</span><span style="color: #008000;"> 0.6
</span><span style="color: #008080;"> 14</span> <span style="color: #008000;"> * </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 15</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> SimChatServer {
</span><span style="color: #008080;"> 16</span>     ServerSocket ss = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 17</span>     <span style="color: #0000ff;">int</span><span style="color: #000000;"> users;
</span><span style="color: #008080;"> 18</span>     
<span style="color: #008080;"> 19</span>     <span style="color: #008000;">/**</span><span style="color: #008000;"> 服务器构造方法，只用来初始化已连接客户端数。</span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 20</span>     <span style="color: #0000ff;">public</span> SimChatServer() {users = 0<span style="color: #000000;">;}
</span><span style="color: #008080;"> 21</span>     
<span style="color: #008080;"> 22</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args) {
</span><span style="color: #008080;"> 23</span>         SimChatServer server = <span style="color: #0000ff;">new</span><span style="color: #000000;"> SimChatServer();
</span><span style="color: #008080;"> 24</span>         
<span style="color: #008080;"> 25</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 尝试启动服务器，端口被占用则提示并退出。</span>
<span style="color: #008080;"> 26</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {
</span><span style="color: #008080;"> 27</span>             server.ss = <span style="color: #0000ff;">new</span> ServerSocket(2333<span style="color: #000000;">);
</span><span style="color: #008080;"> 28</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (BindException e) {
</span><span style="color: #008080;"> 29</span>             System.out.println("Port occupied."<span style="color: #000000;">);
</span><span style="color: #008080;"> 30</span>             System.exit(0<span style="color: #000000;">);
</span><span style="color: #008080;"> 31</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException ex) {
</span><span style="color: #008080;"> 32</span> <span style="color: #000000;">            ex.printStackTrace();
</span><span style="color: #008080;"> 33</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 34</span> 
<span style="color: #008080;"> 35</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 死循环，等待客户端连接，连接成功则启动一个新线程。</span>
<span style="color: #008080;"> 36</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {
</span><span style="color: #008080;"> 37</span>             <span style="color: #0000ff;">do</span><span style="color: #000000;"> {
</span><span style="color: #008080;"> 38</span>                 server.<span style="color: #0000ff;">new</span><span style="color: #000000;"> ClientThread(server, server.ss.accept()).start();
</span><span style="color: #008080;"> 39</span>                 server.users++<span style="color: #000000;">;
</span><span style="color: #008080;"> 40</span>                 System.out.println("Current clients: " +<span style="color: #000000;"> server.users);
</span><span style="color: #008080;"> 41</span>             } <span style="color: #0000ff;">while</span> (server.users &gt; 0<span style="color: #000000;">);
</span><span style="color: #008080;"> 42</span>             
<span style="color: #008080;"> 43</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException e) {
</span><span style="color: #008080;"> 44</span> <span style="color: #000000;">            e.printStackTrace();
</span><span style="color: #008080;"> 45</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 46</span>         
<span style="color: #008080;"> 47</span>         
<span style="color: #008080;"> 48</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 49</span>     
<span style="color: #008080;"> 50</span>     <span style="color: #008000;">/**</span><span style="color: #008000;"> 管理客户端退出的方法。</span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 51</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> clientOut() {
</span><span style="color: #008080;"> 52</span>         users--<span style="color: #000000;">;
</span><span style="color: #008080;"> 53</span>         System.out.println("Current clients: " +<span style="color: #000000;"> users);
</span><span style="color: #008080;"> 54</span>         
<span style="color: #008080;"> 55</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 所有客户端都断开之后关闭服务器。</span>
<span style="color: #008080;"> 56</span>         <span style="color: #0000ff;">if</span> (users == 0<span style="color: #000000;">) {
</span><span style="color: #008080;"> 57</span>             System.out.println("All clients are out, server abort."<span style="color: #000000;">);
</span><span style="color: #008080;"> 58</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {
</span><span style="color: #008080;"> 59</span> <span style="color: #000000;">                ss.close();
</span><span style="color: #008080;"> 60</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException e) {
</span><span style="color: #008080;"> 61</span> <span style="color: #000000;">                e.printStackTrace();
</span><span style="color: #008080;"> 62</span> <span style="color: #000000;">            }
</span><span style="color: #008080;"> 63</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 64</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 65</span>     
<span style="color: #008080;"> 66</span>     <span style="color: #008000;">/**</span>
<span style="color: #008080;"> 67</span> <span style="color: #008000;">     * 内部类。
</span><span style="color: #008080;"> 68</span> <span style="color: #008000;">     * 单个客户端线程，包含了处理客户端发来信息的方法。
</span><span style="color: #008080;"> 69</span> <span style="color: #008000;">     * 目前只能接收信息，之后再加上向客户端发包的功能。
</span><span style="color: #008080;"> 70</span> <span style="color: #008000;">     * 
</span><span style="color: #008080;"> 71</span> <span style="color: #008000;">     * </span><span style="color: #808080;">@author</span><span style="color: #008000;"> mlxy
</span><span style="color: #008080;"> 72</span> <span style="color: #008000;">     * </span><span style="color: #808080;">@version</span><span style="color: #008000;"> 0.5
</span><span style="color: #008080;"> 73</span>      <span style="color: #008000;">*/</span>
<span style="color: #008080;"> 74</span>     <span style="color: #0000ff;">class</span> ClientThread <span style="color: #0000ff;">extends</span><span style="color: #000000;"> Thread {
</span><span style="color: #008080;"> 75</span> <span style="color: #000000;">        SimChatServer server;
</span><span style="color: #008080;"> 76</span> <span style="color: #000000;">        Socket singleSocket;
</span><span style="color: #008080;"> 77</span> <span style="color: #000000;">        ObjectInputStream singleInput;
</span><span style="color: #008080;"> 78</span>         
<span style="color: #008080;"> 79</span>         <span style="color: #008000;">/**</span><span style="color: #008000;"> 一个客户端线程的构造方法。</span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 80</span>         <span style="color: #0000ff;">public</span><span style="color: #000000;"> ClientThread(SimChatServer server, Socket singleSocket) {
</span><span style="color: #008080;"> 81</span>             <span style="color: #0000ff;">this</span>.server =<span style="color: #000000;"> server;
</span><span style="color: #008080;"> 82</span>             <span style="color: #0000ff;">this</span>.singleSocket =<span style="color: #000000;"> singleSocket;
</span><span style="color: #008080;"> 83</span>             System.out.println("Client connected."<span style="color: #000000;">);
</span><span style="color: #008080;"> 84</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {
</span><span style="color: #008080;"> 85</span>                 singleInput = <span style="color: #0000ff;">new</span><span style="color: #000000;"> ObjectInputStream(singleSocket.getInputStream());
</span><span style="color: #008080;"> 86</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException e) {
</span><span style="color: #008080;"> 87</span> <span style="color: #000000;">                e.printStackTrace();
</span><span style="color: #008080;"> 88</span> <span style="color: #000000;">            }
</span><span style="color: #008080;"> 89</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 90</span> 
<span style="color: #008080;"> 91</span> <span style="color: #000000;">        @Override
</span><span style="color: #008080;"> 92</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> run() {
</span><span style="color: #008080;"> 93</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 主运行部分，抓到客户端退出的异常就打印提示并退出。</span>
<span style="color: #008080;"> 94</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {
</span><span style="color: #008080;"> 95</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 死循环，读包拆包打印。</span>
<span style="color: #008080;"> 96</span>                 <span style="color: #0000ff;">while</span> (<span style="color: #0000ff;">true</span><span style="color: #000000;">) {
</span><span style="color: #008080;"> 97</span>                     String[] packReceived =<span style="color: #000000;"> (String[]) singleInput.readObject();
</span><span style="color: #008080;"> 98</span>                     System.out.println(packReceived[0] + ": " + packReceived[1<span style="color: #000000;">]);
</span><span style="color: #008080;"> 99</span> <span style="color: #000000;">                }
</span><span style="color: #008080;">100</span>                     
<span style="color: #008080;">101</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (ClassNotFoundException e) {
</span><span style="color: #008080;">102</span> <span style="color: #000000;">                e.printStackTrace();
</span><span style="color: #008080;">103</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (EOFException ex) {
</span><span style="color: #008080;">104</span>                 System.out.println("Client disconnected."<span style="color: #000000;">);
</span><span style="color: #008080;">105</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException exc) {
</span><span style="color: #008080;">106</span> <span style="color: #000000;">                exc.printStackTrace();
</span><span style="color: #008080;">107</span>             } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {
</span><span style="color: #008080;">108</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 关闭所有引用，释放资源。</span>
<span style="color: #008080;">109</span>                 <span style="color: #0000ff;">try</span><span style="color: #000000;"> {
</span><span style="color: #008080;">110</span>                     <span style="color: #0000ff;">if</span> (singleSocket != <span style="color: #0000ff;">null</span><span style="color: #000000;">)
</span><span style="color: #008080;">111</span> <span style="color: #000000;">                        singleSocket.close();
</span><span style="color: #008080;">112</span>                     <span style="color: #0000ff;">if</span> (singleInput != <span style="color: #0000ff;">null</span><span style="color: #000000;">)
</span><span style="color: #008080;">113</span> <span style="color: #000000;">                        singleInput.close();
</span><span style="color: #008080;">114</span>                     
<span style="color: #008080;">115</span>                     <span style="color: #008000;">//</span><span style="color: #008000;"> 报告一个客户端退出。</span>
<span style="color: #008080;">116</span> <span style="color: #000000;">                    server.clientOut();
</span><span style="color: #008080;">117</span>                 } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException e) {
</span><span style="color: #008080;">118</span> <span style="color: #000000;">                    e.printStackTrace();
</span><span style="color: #008080;">119</span> <span style="color: #000000;">                }
</span><span style="color: #008080;">120</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">121</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">122</span>         
<span style="color: #008080;">123</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">124</span> }</pre>
</div>
<span class="cnblogs_code_collapse">Server端</span></div>
<p>&nbsp;</p>

<div align=right><a href="https://github.com/mlxy/SRBCnblogs"><font size=1>——本文由博客园搬家工具SRBCnblogs转换而成</font></a></div>