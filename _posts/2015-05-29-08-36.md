---
layout: post
title: 由LruCache和DiskLruCache提供三级缓存支持的ImageLoader
date: 2015-05-29 08:36:00
categories: cnblogs
---

<p>从三天前一直报错到今天中午，总算出了个能用的版本了。</p>
<p>一如既往先发链接：</p>
<p>https://github.com/mlxy/ImageLoader</p>
<p>&nbsp;</p>
<p><span style="text-decoration: underline;"><span style="font-size: 18pt;">缓存处理</span></span></p>
<p>&nbsp;</p>
<p><strong>&middot;LruCacheHelper:</strong></p>
<p>封装第一级缓存，也就是内存缓存的处理。</p>
<p>LruCache是Android自带的缓存处理类，如名字所说，和使用软引用的映射相比，优势在于可以忽略缓存上限处理的细节问题，初始化时<span style="line-height: 1.5;">在构造函数中给一个缓存上限即可。一般做法是使用最大内存的八分之一：</span></p>
<blockquote>
<pre>Runtime.getRuntime().maxMemory() / 8</pre>
</blockquote>
<p>但是我觉得八分之一实在太少，所以干脆给了三分之一。</p>
<p>另外在初始化时需要重写LruCache类的sizeOf方法来自行计算图片的大小并返回，默认情况返回的是图片数量。</p>
<p>封装类给出四个接口，分别是打开和关闭，保存和读取。</p>
<p>没什么好说的，直接放代码。</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('7ae51d63-af5b-4850-88ba-faed42981f72')"><img id="code_img_closed_7ae51d63-af5b-4850-88ba-faed42981f72" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_7ae51d63-af5b-4850-88ba-faed42981f72" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('7ae51d63-af5b-4850-88ba-faed42981f72',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_7ae51d63-af5b-4850-88ba-faed42981f72" class="cnblogs_code_hide">
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> LruCacheHelper {
</span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> LruCacheHelper() {}
</span><span style="color: #008080;"> 3</span> 
<span style="color: #008080;"> 4</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> LruCache&lt;String, Bitmap&gt;<span style="color: #000000;"> mCache;
</span><span style="color: #008080;"> 5</span> 
<span style="color: #008080;"> 6</span>     <span style="color: #008000;">/**</span><span style="color: #008000;"> 初始化LruCache。 </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> openCache(<span style="color: #0000ff;">int</span><span style="color: #000000;"> maxSize) {
</span><span style="color: #008080;"> 8</span>         mCache = <span style="color: #0000ff;">new</span> LruCache&lt;String, Bitmap&gt;((<span style="color: #0000ff;">int</span><span style="color: #000000;">) maxSize) {
</span><span style="color: #008080;"> 9</span> <span style="color: #000000;">            @Override
</span><span style="color: #008080;">10</span>             <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> sizeOf(String key, Bitmap value) {
</span><span style="color: #008080;">11</span>                 <span style="color: #0000ff;">return</span> value.getRowBytes() *<span style="color: #000000;"> value.getHeight();
</span><span style="color: #008080;">12</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">13</span> <span style="color: #000000;">        };
</span><span style="color: #008080;">14</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">15</span> 
<span style="color: #008080;">16</span>     <span style="color: #008000;">/**</span><span style="color: #008000;"> 把图片写入缓存。 </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">17</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> dump(String key, Bitmap value) {
</span><span style="color: #008080;">18</span> <span style="color: #000000;">        mCache.put(key, value);
</span><span style="color: #008080;">19</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">20</span> 
<span style="color: #008080;">21</span>     <span style="color: #008000;">/**</span><span style="color: #008000;"> 从缓存中读取图片数据。 </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">22</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> Bitmap load(String key) {
</span><span style="color: #008080;">23</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> mCache.get(key);
</span><span style="color: #008080;">24</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">25</span> 
<span style="color: #008080;">26</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> closeCache() {
</span><span style="color: #008080;">27</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 暂时没事干。</span>
<span style="color: #008080;">28</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">29</span> }</pre>
</div>
<span class="cnblogs_code_collapse">LruCacheHelper</span></div>
<p>&nbsp;</p>
<p><strong>&middot;DiskLruCacheHelper:</strong></p>
<p>DiskLruCache工具的使用以及这个类的基本介绍可以参考我前两天写的<a id="homepage1_HomePageDays_DaysList_ctl01_DayList_TitleUrl_1" class="postTitle2" href="http://www.cnblogs.com/chihane/p/4517196.html">基于Demo解析缓存工具DiskLruCache</a>。</p>
<p>为了适应这个工程的需要对这个封装类做了一点变动，直接保存和读取Bitmap。</p>
<p>依然没什么好说的，直接看代码。</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('207b0462-c547-4459-9b24-0107fd003eda')"><img id="code_img_closed_207b0462-c547-4459-9b24-0107fd003eda" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_207b0462-c547-4459-9b24-0107fd003eda" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('207b0462-c547-4459-9b24-0107fd003eda',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_207b0462-c547-4459-9b24-0107fd003eda" class="cnblogs_code_hide">
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> DiskLruCacheHelper {
</span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> DiskLruCacheHelper() {}
</span><span style="color: #008080;"> 3</span> 
<span style="color: #008080;"> 4</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> DiskLruCache mCache;
</span><span style="color: #008080;"> 5</span> 
<span style="color: #008080;"> 6</span>     <span style="color: #008000;">/**</span><span style="color: #008000;"> 打开DiskLruCache。 </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> openCache(Context context, <span style="color: #0000ff;">int</span> appVersion, <span style="color: #0000ff;">int</span><span style="color: #000000;"> maxSize) {
</span><span style="color: #008080;"> 8</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {
</span><span style="color: #008080;"> 9</span>             <span style="color: #0000ff;">if</span><span style="color: #000000;"> (Environment.MEDIA_MOUNTED.equals(Environment.getExternalStorageState())
</span><span style="color: #008080;">10</span>                     || !<span style="color: #000000;">Environment.isExternalStorageRemovable()) {
</span><span style="color: #008080;">11</span>                 mCache = DiskLruCache.open(context.getExternalCacheDir(), appVersion, 1<span style="color: #000000;">, maxSize);
</span><span style="color: #008080;">12</span>             } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {
</span><span style="color: #008080;">13</span>                 mCache = DiskLruCache.open(context.getCacheDir(), appVersion, 1<span style="color: #000000;">, maxSize);
</span><span style="color: #008080;">14</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">15</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException e) { e.printStackTrace(); }
</span><span style="color: #008080;">16</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">17</span> 
<span style="color: #008080;">18</span>     <span style="color: #008000;">/**</span><span style="color: #008000;"> 写出缓存。 </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">19</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> dump(Bitmap bitmap, String keyCache) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> IOException {
</span><span style="color: #008080;">20</span>         <span style="color: #0000ff;">if</span> (mCache == <span style="color: #0000ff;">null</span>) <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> IllegalStateException("Must call openCache() first!"<span style="color: #000000;">);
</span><span style="color: #008080;">21</span> 
<span style="color: #008080;">22</span>         DiskLruCache.Editor editor =<span style="color: #000000;"> mCache.edit(Digester.hashUp(keyCache));
</span><span style="color: #008080;">23</span> 
<span style="color: #008080;">24</span>         <span style="color: #0000ff;">if</span> (editor != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
</span><span style="color: #008080;">25</span>             OutputStream outputStream = editor.newOutputStream(0<span style="color: #000000;">);
</span><span style="color: #008080;">26</span>             <span style="color: #0000ff;">boolean</span> success = bitmap.compress(Bitmap.CompressFormat.PNG, 100<span style="color: #000000;">, outputStream);
</span><span style="color: #008080;">27</span> 
<span style="color: #008080;">28</span>             <span style="color: #0000ff;">if</span><span style="color: #000000;"> (success) {
</span><span style="color: #008080;">29</span> <span style="color: #000000;">                editor.commit();
</span><span style="color: #008080;">30</span>             } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {
</span><span style="color: #008080;">31</span> <span style="color: #000000;">                editor.abort();
</span><span style="color: #008080;">32</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">33</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">34</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">35</span> 
<span style="color: #008080;">36</span>     <span style="color: #008000;">/**</span><span style="color: #008000;"> 读取缓存。 </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">37</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> Bitmap load(String keyCache) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> IOException {
</span><span style="color: #008080;">38</span>         <span style="color: #0000ff;">if</span> (mCache == <span style="color: #0000ff;">null</span>) <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> IllegalStateException("Must call openCache() first!"<span style="color: #000000;">);
</span><span style="color: #008080;">39</span> 
<span style="color: #008080;">40</span>         DiskLruCache.Snapshot snapshot =<span style="color: #000000;"> mCache.get(Digester.hashUp(keyCache));
</span><span style="color: #008080;">41</span> 
<span style="color: #008080;">42</span>         <span style="color: #0000ff;">if</span> (snapshot != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
</span><span style="color: #008080;">43</span>             InputStream inputStream = snapshot.getInputStream(0<span style="color: #000000;">);
</span><span style="color: #008080;">44</span>             Bitmap bitmap =<span style="color: #000000;"> BitmapFactory.decodeStream(inputStream);
</span><span style="color: #008080;">45</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> bitmap;
</span><span style="color: #008080;">46</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">47</span> 
<span style="color: #008080;">48</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;
</span><span style="color: #008080;">49</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">50</span> 
<span style="color: #008080;">51</span>     <span style="color: #008000;">/**</span><span style="color: #008000;"> 检查缓存是否存在。 </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">52</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> hasCache(String keyCache) {
</span><span style="color: #008080;">53</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {
</span><span style="color: #008080;">54</span>             <span style="color: #0000ff;">return</span> mCache.get(Digester.hashUp(keyCache)) != <span style="color: #0000ff;">null</span><span style="color: #000000;">;
</span><span style="color: #008080;">55</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException e) {
</span><span style="color: #008080;">56</span> <span style="color: #000000;">            e.printStackTrace();
</span><span style="color: #008080;">57</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">58</span> 
<span style="color: #008080;">59</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">;
</span><span style="color: #008080;">60</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">61</span> 
<span style="color: #008080;">62</span>     <span style="color: #008000;">/**</span><span style="color: #008000;"> 同步日志。 </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">63</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> syncLog() {
</span><span style="color: #008080;">64</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {
</span><span style="color: #008080;">65</span> <span style="color: #000000;">            mCache.flush();
</span><span style="color: #008080;">66</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException e) { e.printStackTrace(); }
</span><span style="color: #008080;">67</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">68</span> 
<span style="color: #008080;">69</span>     <span style="color: #008000;">/**</span><span style="color: #008000;"> 关闭DiskLruCache。 </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">70</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> closeCache() {
</span><span style="color: #008080;">71</span> <span style="color: #000000;">        syncLog();
</span><span style="color: #008080;">72</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">73</span> }</pre>
</div>
<span class="cnblogs_code_collapse">DiskLruCacheHelper</span></div>
<p>&nbsp;</p>
<p><span style="text-decoration: underline;"><span style="font-size: 18pt;">ImageLoader主类</span></span></p>
<p>&nbsp;</p>
<p>从接口说起，类依然是四个接口，初始化，关闭，载入图片，取消载入。</p>
<p>载入分三步，逐级访问三级缓存。</p>
<p>&nbsp;</p>
<p><strong>&middot;一：</strong></p>
<p>首先使用内存缓存的封装类调取内存缓存，如果内存中有，就直接显示。</p>
<div class="cnblogs_code">
<pre><span style="color: #008000;">/**</span><span style="color: #008000;"> 从内存缓存中加载图片。 </span><span style="color: #008000;">*/</span>
<span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> loadImageFromMemory(View parent, String url) {
    Bitmap bitmap </span>=<span style="color: #000000;"> LruCacheHelper.load(url);
    </span><span style="color: #0000ff;">if</span> (bitmap != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
        setImage(parent, bitmap, url);
        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;
    }

    </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">;
}</span></pre>
</div>
<p>返回一个标志位用以判断是否已经加载成功。</p>
<p>&nbsp;</p>
<p>如果没成功就要访问第二级缓存也即磁盘缓存了，使用封装类检查缓存存在与否，之后分成两个分支。</p>
<p>&nbsp;</p>
<p><strong>&middot;二：</strong></p>
<p>如果磁盘缓存已经存在了，就启动读取磁盘缓存的任务。</p>
<p>启动时记得把任务加入一个HashMap中，用于在被外部中断或程序执行结束时取消任务。</p>
<p>&nbsp;</p>
<p>任务使用Android自带的AsyncTask异步任务类。</p>
<p>编写一个类，继承AsyncTask并指定泛型。</p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">class</span> LoadImageDiskCacheTask <span style="color: #0000ff;">extends</span> AsyncTask&lt;String, Void, Bitmap&gt;</pre>
</div>
<p>&nbsp;</p>
<p>泛型第一位是启动任务时传入的参数类型，我们这里要传入的是图片的URL，所以用String。</p>
<p>这个参数在用AsyncTask.execute(Params...)启动任务时传入，在<span style="line-height: 1.5;">继承AsyncTask类必须重写的抽象方法doInBackground(Params...)中接收。</span></p>
<p>&nbsp;</p>
<p>第二位是进度的类型。在任务执行的过程中，可以调用publishProgress(Progress)方法不断更新任务进度，比如已下载的文件大小或者已经删除的文件数量之类。</p>
<p>之后重写onProgressUpdate(Progress)方法，在进度更新时做出相应处理，比如修改进度条的值。</p>
<p>在这里我们不需要进度的处理，所以直接给Void，注意V大写。</p>
<p>&nbsp;</p>
<p>泛型第三位就是任务结束后返回的结果的类型了。</p>
<p>重写onPostExecute(Result)方法，参数就是doInBackground方法返回的结果。在这里接收图片并显示就可以了。</p>
<p>&nbsp;</p>
<p>注意，doInBackground方法是在新线程中执行，而onPostExecute是在主线程中执行的，这也是这个类高明的地方之一，使用AsyncTask类从头至尾都不需要手动处理线程问题，只需要关注业务逻辑。</p>
<p>之后可能研究一下这个类再单独写一篇博文。</p>
<p>&nbsp;</p>
<p>在磁盘缓存读取成功之后我们也在内存缓存中保存一份。</p>
<p>&nbsp;</p>
<p><strong>&middot;三：</strong></p>
<p>如果没有磁盘缓存，比如第一次打开应用程序的时候，就需要从网络上重新下载图片了。</p>
<p>依旧是继承AsyncTask类，在doInBackground方法中联网下载图片，下载成功后分别保存到磁盘缓存和内存缓存，之后再onPostExecute方法中显示图片。</p>
<p>逻辑和第二步是一样的。</p>
<p>&nbsp;</p>
<p><strong>&middot;显示图片：</strong></p>
<p>但是。</p>
<p>如果就这么不管不顾地开始用，比如用在一个纯图片的ListView中，就会发现在滑动ListView的时候有时图片会显示不出来，有时还会不停闪烁。</p>
<p>问题就出在多线程上。</p>
<p>如果使用Google官方推荐的ListView优化方式，也就是在列表适配器中的getView方法里复用convertView</p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">if</span> (convertView == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
    imageView </span>= (ImageView) View.inflate(MainActivity.<span style="color: #0000ff;">this</span>, R.layout.image_view, <span style="color: #0000ff;">null</span><span style="color: #000000;">);

    convertView </span>=<span style="color: #000000;"> imageView;
} </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
    imageView </span>=<span style="color: #000000;"> (ImageView) convertView;
}</span></pre>
</div>
<p>的话，由于读取图片需要一定的时间，当图片读取完毕时，传给ImageLoader的那个ImageView可能已经不是当初的那个ImageView了。</p>
<p>我在解决这个问题时，发现网上多数的建议是给ImageView绑定URL作为Tag，然后在显示图片时检查Tag和URL是否一致，不一致就不显示。</p>
<p>但是不显示明显不行啊。</p>
<p>&nbsp;</p>
<p>我的解决办法是改变思路。</p>
<p>在调用ImageLoader.load时传入的不是符合直觉的ImageView和URL，而是getView的第三个参数，ImageView的父视图parent和URL，到了显示图片的时候再在主线程中用View.findViewWithTag方法来现场获取ImageView并设置图片。</p>
<p>这样就成功地避免了图片的显示错位。</p>
<p>&nbsp;</p>
<p><strong>&middot;OutOfMemory异常：</strong></p>
<p>其实这个异常在正常情况下不是很容易出现了，这里只提供一个思路。</p>
<p>给ListView绑定RecyclerListener，实现onMovedToScrapHeap(View)方法，这个方法在列表项移出屏幕外时会被调用，我们在这个方法中取消图片的加载任务，始终保持只加载屏幕内的图片，基本就不会出现内存不够用的情况了。</p>
<p>当然，如果图片实在太大，那就要在解析Bitmap的时候配合Options来自行缩放图片大小，那就是另一回事了。</p>
<p>&nbsp;</p>
<p>最后还是代码说话：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('862860e3-6360-42f4-8f7b-c21d31900cf9')"><img id="code_img_closed_862860e3-6360-42f4-8f7b-c21d31900cf9" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_862860e3-6360-42f4-8f7b-c21d31900cf9" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('862860e3-6360-42f4-8f7b-c21d31900cf9',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_862860e3-6360-42f4-8f7b-c21d31900cf9" class="cnblogs_code_hide">
<pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> ImageLoader {
</span><span style="color: #008080;">  2</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> MEMORY_CACHE_SIZE_LIMIT =
<span style="color: #008080;">  3</span>             (<span style="color: #0000ff;">int</span>) (Runtime.getRuntime().maxMemory() / 3<span style="color: #000000;">);
</span><span style="color: #008080;">  4</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> LOCAL_CACHE_SIZE_LIMIT =
<span style="color: #008080;">  5</span>             100 * 1024 * 1024<span style="color: #000000;">;
</span><span style="color: #008080;">  6</span> 
<span style="color: #008080;">  7</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> NETWORK_TIMEOUT = 5000<span style="color: #000000;">;
</span><span style="color: #008080;">  8</span> 
<span style="color: #008080;">  9</span>     <span style="color: #0000ff;">private</span> HashMap&lt;String, AsyncTask&gt; taskMap = <span style="color: #0000ff;">new</span> HashMap&lt;&gt;<span style="color: #000000;">();
</span><span style="color: #008080;"> 10</span> 
<span style="color: #008080;"> 11</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> ImageLoader(Context context) {
</span><span style="color: #008080;"> 12</span> <span style="color: #000000;">        initMemoryCache();
</span><span style="color: #008080;"> 13</span> <span style="color: #000000;">        initDiskCache(context);
</span><span style="color: #008080;"> 14</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 15</span> 
<span style="color: #008080;"> 16</span>     <span style="color: #008000;">/**</span><span style="color: #008000;"> 初始化内存缓存器。 </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 17</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> initMemoryCache() {
</span><span style="color: #008080;"> 18</span> <span style="color: #000000;">        LruCacheHelper.openCache(MEMORY_CACHE_SIZE_LIMIT);
</span><span style="color: #008080;"> 19</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 20</span> 
<span style="color: #008080;"> 21</span>     <span style="color: #008000;">/**</span><span style="color: #008000;"> 初始化磁盘缓存器。 </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 22</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> initDiskCache(Context context) {
</span><span style="color: #008080;"> 23</span>         <span style="color: #0000ff;">int</span> appVersion = 1<span style="color: #000000;">;
</span><span style="color: #008080;"> 24</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {
</span><span style="color: #008080;"> 25</span>             appVersion = context.getPackageManager().getPackageInfo(context.getPackageName(), 0<span style="color: #000000;">).versionCode;
</span><span style="color: #008080;"> 26</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (PackageManager.NameNotFoundException e) {
</span><span style="color: #008080;"> 27</span> <span style="color: #000000;">            e.printStackTrace();
</span><span style="color: #008080;"> 28</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 29</span> 
<span style="color: #008080;"> 30</span> <span style="color: #000000;">        DiskLruCacheHelper.openCache(context, appVersion, LOCAL_CACHE_SIZE_LIMIT);
</span><span style="color: #008080;"> 31</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 32</span> 
<span style="color: #008080;"> 33</span>     <span style="color: #008000;">/**</span><span style="color: #008000;"> 载入图片。
</span><span style="color: #008080;"> 34</span> <span style="color: #008000;">     *  </span><span style="color: #808080;">@param</span><span style="color: #008000;"> parent 要显示图片的视图的父视图。
</span><span style="color: #008080;"> 35</span> <span style="color: #008000;">     *  </span><span style="color: #808080;">@param</span><span style="color: #008000;"> url 要显示的图片的URL。
</span><span style="color: #008080;"> 36</span> <span style="color: #008000;">     * </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 37</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> load(View parent, String url) {
</span><span style="color: #008080;"> 38</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 尝试从内存缓存载入图片。</span>
<span style="color: #008080;"> 39</span>         <span style="color: #0000ff;">boolean</span> succeeded =<span style="color: #000000;"> loadImageFromMemory(parent, url);
</span><span style="color: #008080;"> 40</span>         <span style="color: #0000ff;">if</span> (succeeded) <span style="color: #0000ff;">return</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 41</span> 
<span style="color: #008080;"> 42</span>         <span style="color: #0000ff;">boolean</span> hasCache =<span style="color: #000000;"> DiskLruCacheHelper.hasCache(url);
</span><span style="color: #008080;"> 43</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;"> (hasCache) {
</span><span style="color: #008080;"> 44</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 有磁盘缓存。</span>
<span style="color: #008080;"> 45</span> <span style="color: #000000;">            loadImageFromDisk(parent, url);
</span><span style="color: #008080;"> 46</span>         } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {
</span><span style="color: #008080;"> 47</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 联网下载。</span>
<span style="color: #008080;"> 48</span> <span style="color: #000000;">            loadFromInternet(parent, url);
</span><span style="color: #008080;"> 49</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 50</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 51</span> 
<span style="color: #008080;"> 52</span>     <span style="color: #008000;">/**</span><span style="color: #008000;"> 取消任务。 </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 53</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> cancel(String tag) {
</span><span style="color: #008080;"> 54</span>         AsyncTask removedTask =<span style="color: #000000;"> taskMap.remove(tag);
</span><span style="color: #008080;"> 55</span>         <span style="color: #0000ff;">if</span> (removedTask != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
</span><span style="color: #008080;"> 56</span>             removedTask.cancel(<span style="color: #0000ff;">false</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 57</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 58</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 59</span> 
<span style="color: #008080;"> 60</span>     <span style="color: #008000;">/**</span><span style="color: #008000;"> 从内存缓存中加载图片。 </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 61</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> loadImageFromMemory(View parent, String url) {
</span><span style="color: #008080;"> 62</span>         Bitmap bitmap =<span style="color: #000000;"> LruCacheHelper.load(url);
</span><span style="color: #008080;"> 63</span>         <span style="color: #0000ff;">if</span> (bitmap != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
</span><span style="color: #008080;"> 64</span> <span style="color: #000000;">            setImage(parent, bitmap, url);
</span><span style="color: #008080;"> 65</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 66</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 67</span> 
<span style="color: #008080;"> 68</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 69</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 70</span> 
<span style="color: #008080;"> 71</span>     <span style="color: #008000;">/**</span><span style="color: #008000;"> 从磁盘缓存中加载图片。 </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 72</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> loadImageFromDisk(View parent, String url) {
</span><span style="color: #008080;"> 73</span>         LoadImageDiskCacheTask task = <span style="color: #0000ff;">new</span><span style="color: #000000;"> LoadImageDiskCacheTask(parent);
</span><span style="color: #008080;"> 74</span> <span style="color: #000000;">        taskMap.put(url, task);
</span><span style="color: #008080;"> 75</span> <span style="color: #000000;">        task.execute(url);
</span><span style="color: #008080;"> 76</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 77</span> 
<span style="color: #008080;"> 78</span>     <span style="color: #008000;">/**</span><span style="color: #008000;"> 从网络上下载图片。 </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 79</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> loadFromInternet(View parent, String url) {
</span><span style="color: #008080;"> 80</span>         DownloadImageTask task = <span style="color: #0000ff;">new</span><span style="color: #000000;"> DownloadImageTask(parent);
</span><span style="color: #008080;"> 81</span> <span style="color: #000000;">        taskMap.put(url, task);
</span><span style="color: #008080;"> 82</span> <span style="color: #000000;">        task.execute(url);
</span><span style="color: #008080;"> 83</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 84</span> 
<span style="color: #008080;"> 85</span>     <span style="color: #008000;">/**</span><span style="color: #008000;"> 把图片保存到内存缓存。 </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 86</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> putImageIntoMemoryCache(String url, Bitmap bitmap) {
</span><span style="color: #008080;"> 87</span> <span style="color: #000000;">        LruCacheHelper.dump(url, bitmap);
</span><span style="color: #008080;"> 88</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 89</span> 
<span style="color: #008080;"> 90</span>     <span style="color: #008000;">/**</span><span style="color: #008000;"> 把图片保存到磁盘缓存。 </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 91</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> putImageIntoDiskCache(String url, Bitmap bitmap) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> IOException {
</span><span style="color: #008080;"> 92</span> <span style="color: #000000;">        DiskLruCacheHelper.dump(bitmap, url);
</span><span style="color: #008080;"> 93</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 94</span> 
<span style="color: #008080;"> 95</span>     <span style="color: #008000;">/**</span><span style="color: #008000;"> 重新设置图片。 </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 96</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> setImage(<span style="color: #0000ff;">final</span> View parent, <span style="color: #0000ff;">final</span> Bitmap bitmap, <span style="color: #0000ff;">final</span><span style="color: #000000;"> String url) {
</span><span style="color: #008080;"> 97</span>         parent.post(<span style="color: #0000ff;">new</span><span style="color: #000000;"> Runnable() {
</span><span style="color: #008080;"> 98</span> <span style="color: #000000;">            @Override
</span><span style="color: #008080;"> 99</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> run() {
</span><span style="color: #008080;">100</span>                 ImageView imageView =<span style="color: #000000;"> findImageViewWithTag(parent, url);
</span><span style="color: #008080;">101</span>                 <span style="color: #0000ff;">if</span> (imageView != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
</span><span style="color: #008080;">102</span> <span style="color: #000000;">                    imageView.setImageBitmap(bitmap);
</span><span style="color: #008080;">103</span> <span style="color: #000000;">                }
</span><span style="color: #008080;">104</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">105</span> <span style="color: #000000;">        });
</span><span style="color: #008080;">106</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">107</span> 
<span style="color: #008080;">108</span>     <span style="color: #008000;">/**</span><span style="color: #008000;"> 根据Tag找到指定的ImageView。 </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">109</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> ImageView findImageViewWithTag(View parent, String tag) {
</span><span style="color: #008080;">110</span>         View view =<span style="color: #000000;"> parent.findViewWithTag(tag);
</span><span style="color: #008080;">111</span>         <span style="color: #0000ff;">if</span> (view != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
</span><span style="color: #008080;">112</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> (ImageView) view;
</span><span style="color: #008080;">113</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">114</span> 
<span style="color: #008080;">115</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;
</span><span style="color: #008080;">116</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">117</span> 
<span style="color: #008080;">118</span>     <span style="color: #008000;">/**</span><span style="color: #008000;"> 读取图片磁盘缓存的任务。 </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">119</span>     <span style="color: #0000ff;">class</span> LoadImageDiskCacheTask <span style="color: #0000ff;">extends</span> AsyncTask&lt;String, Void, Bitmap&gt;<span style="color: #000000;"> {
</span><span style="color: #008080;">120</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">final</span><span style="color: #000000;"> View parent;
</span><span style="color: #008080;">121</span>         <span style="color: #0000ff;">private</span><span style="color: #000000;"> String url;
</span><span style="color: #008080;">122</span> 
<span style="color: #008080;">123</span>         <span style="color: #0000ff;">public</span><span style="color: #000000;"> LoadImageDiskCacheTask(View parent) {
</span><span style="color: #008080;">124</span>             <span style="color: #0000ff;">this</span>.parent =<span style="color: #000000;"> parent;
</span><span style="color: #008080;">125</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">126</span> 
<span style="color: #008080;">127</span> <span style="color: #000000;">        @Override
</span><span style="color: #008080;">128</span>         <span style="color: #0000ff;">protected</span><span style="color: #000000;"> Bitmap doInBackground(String... params) {
</span><span style="color: #008080;">129</span>             Bitmap bitmap = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
</span><span style="color: #008080;">130</span> 
<span style="color: #008080;">131</span>             url = params[0<span style="color: #000000;">];
</span><span style="color: #008080;">132</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {
</span><span style="color: #008080;">133</span>                 bitmap =<span style="color: #000000;"> DiskLruCacheHelper.load(url);
</span><span style="color: #008080;">134</span> 
<span style="color: #008080;">135</span>                 <span style="color: #0000ff;">if</span> (bitmap != <span style="color: #0000ff;">null</span> &amp;&amp; !<span style="color: #000000;">isCancelled()) {
</span><span style="color: #008080;">136</span>                     <span style="color: #008000;">//</span><span style="color: #008000;"> 读取完成后保存到内存缓存。</span>
<span style="color: #008080;">137</span> <span style="color: #000000;">                    putImageIntoMemoryCache(url, bitmap);
</span><span style="color: #008080;">138</span> <span style="color: #000000;">                }
</span><span style="color: #008080;">139</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException e) {
</span><span style="color: #008080;">140</span> <span style="color: #000000;">                e.printStackTrace();
</span><span style="color: #008080;">141</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">142</span> 
<span style="color: #008080;">143</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> bitmap;
</span><span style="color: #008080;">144</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">145</span> 
<span style="color: #008080;">146</span> <span style="color: #000000;">        @Override
</span><span style="color: #008080;">147</span>         <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onPostExecute(Bitmap bitmap) {
</span><span style="color: #008080;">148</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 显示图片。</span>
<span style="color: #008080;">149</span>             <span style="color: #0000ff;">if</span> (bitmap != <span style="color: #0000ff;">null</span><span style="color: #000000;">) setImage(parent, bitmap, url);
</span><span style="color: #008080;">150</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 移除任务。</span>
<span style="color: #008080;">151</span>             <span style="color: #0000ff;">if</span><span style="color: #000000;"> (taskMap.containsKey(url)) taskMap.remove(url);
</span><span style="color: #008080;">152</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">153</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">154</span> 
<span style="color: #008080;">155</span>     <span style="color: #008000;">/**</span><span style="color: #008000;"> 下载图片的任务。 </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">156</span>     <span style="color: #0000ff;">class</span> DownloadImageTask <span style="color: #0000ff;">extends</span> AsyncTask&lt;String, Void, Bitmap&gt;<span style="color: #000000;"> {
</span><span style="color: #008080;">157</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">final</span><span style="color: #000000;"> View parent;
</span><span style="color: #008080;">158</span>         <span style="color: #0000ff;">private</span><span style="color: #000000;"> String url;
</span><span style="color: #008080;">159</span> 
<span style="color: #008080;">160</span>         <span style="color: #0000ff;">public</span><span style="color: #000000;"> DownloadImageTask(View parent) {
</span><span style="color: #008080;">161</span>             <span style="color: #0000ff;">this</span>.parent =<span style="color: #000000;"> parent;
</span><span style="color: #008080;">162</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">163</span> 
<span style="color: #008080;">164</span> <span style="color: #000000;">        @Override
</span><span style="color: #008080;">165</span>         <span style="color: #0000ff;">protected</span><span style="color: #000000;"> Bitmap doInBackground(String... params) {
</span><span style="color: #008080;">166</span>             Bitmap bitmap = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
</span><span style="color: #008080;">167</span> 
<span style="color: #008080;">168</span>             url = params[0<span style="color: #000000;">];
</span><span style="color: #008080;">169</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {
</span><span style="color: #008080;">170</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 下载并解析图片。</span>
<span style="color: #008080;">171</span>                 InputStream inputStream =<span style="color: #000000;"> NetworkAdministrator.openUrlInputStream(url, NETWORK_TIMEOUT);
</span><span style="color: #008080;">172</span>                 bitmap =<span style="color: #000000;"> BitmapFactory.decodeStream(inputStream);
</span><span style="color: #008080;">173</span> 
<span style="color: #008080;">174</span>                 <span style="color: #0000ff;">if</span> (bitmap != <span style="color: #0000ff;">null</span> &amp;&amp; !<span style="color: #000000;">isCancelled()) {
</span><span style="color: #008080;">175</span>                     <span style="color: #008000;">//</span><span style="color: #008000;"> 保存到缓存。</span>
<span style="color: #008080;">176</span> <span style="color: #000000;">                    putImageIntoMemoryCache(url, bitmap);
</span><span style="color: #008080;">177</span> <span style="color: #000000;">                    putImageIntoDiskCache(url, bitmap);
</span><span style="color: #008080;">178</span> <span style="color: #000000;">                }
</span><span style="color: #008080;">179</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException e) {
</span><span style="color: #008080;">180</span> <span style="color: #000000;">                e.printStackTrace();
</span><span style="color: #008080;">181</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">182</span> 
<span style="color: #008080;">183</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> bitmap;
</span><span style="color: #008080;">184</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">185</span> 
<span style="color: #008080;">186</span> <span style="color: #000000;">        @Override
</span><span style="color: #008080;">187</span>         <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onPostExecute(Bitmap bitmap) {
</span><span style="color: #008080;">188</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 显示图片。</span>
<span style="color: #008080;">189</span>             <span style="color: #0000ff;">if</span> (bitmap != <span style="color: #0000ff;">null</span><span style="color: #000000;">) setImage(parent, bitmap, url);
</span><span style="color: #008080;">190</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 移除任务。</span>
<span style="color: #008080;">191</span>             <span style="color: #0000ff;">if</span><span style="color: #000000;"> (taskMap.containsKey(url)) taskMap.remove(url);
</span><span style="color: #008080;">192</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">193</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">194</span> 
<span style="color: #008080;">195</span>     <span style="color: #008000;">/**</span><span style="color: #008000;"> 使用完毕必须调用。 </span><span style="color: #008000;">*/</span>
<span style="color: #008080;">196</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> close() {
</span><span style="color: #008080;">197</span>         <span style="color: #0000ff;">for</span> (Map.Entry&lt;String, AsyncTask&gt;<span style="color: #000000;"> entry : taskMap.entrySet()) {
</span><span style="color: #008080;">198</span>             entry.getValue().cancel(<span style="color: #0000ff;">true</span><span style="color: #000000;">);
</span><span style="color: #008080;">199</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">200</span> 
<span style="color: #008080;">201</span> <span style="color: #000000;">        DiskLruCacheHelper.closeCache();
</span><span style="color: #008080;">202</span> <span style="color: #000000;">        LruCacheHelper.closeCache();
</span><span style="color: #008080;">203</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">204</span> }</pre>
</div>
<span class="cnblogs_code_collapse">ImageLoader</span></div>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="text-decoration: underline; font-size: 18pt;">碎碎念</span></p>
<p>我怎么觉得我今天行文风格有点异常&hellip;&hellip;</p>

<p align=right><span style="font-size: 12px">——本文由博客园搬家工具<a href="https://github.com/mlxy/SRBCnblogs">SRBCnblogs</a>转换而成</span></p>