---
layout: post
title: 重构了XmlDownloader类
date: 2014-03-27 18:02:00
categories: cnblogs
---

<p>用了建造者模式。</p>
<p>在公交车上考虑了两天，在脑子里大概画了个雏形，然后今晚解决了一些细节上的问题。</p>
<p>不废话，发代码：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('3c6a3eff-8206-482c-9244-78247f505d04')"><img id="code_img_closed_3c6a3eff-8206-482c-9244-78247f505d04" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_3c6a3eff-8206-482c-9244-78247f505d04" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('3c6a3eff-8206-482c-9244-78247f505d04',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_3c6a3eff-8206-482c-9244-78247f505d04" class="cnblogs_code_hide">
<pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.mlxy.xml;
</span><span style="color: #008080;">  2</span> 
<span style="color: #008080;">  3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.BufferedReader;
</span><span style="color: #008080;">  4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.BufferedWriter;
</span><span style="color: #008080;">  5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.File;
</span><span style="color: #008080;">  6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.FileOutputStream;
</span><span style="color: #008080;">  7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.InputStream;
</span><span style="color: #008080;">  8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.InputStreamReader;
</span><span style="color: #008080;">  9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.OutputStreamWriter;
</span><span style="color: #008080;"> 10</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.net.MalformedURLException;
</span><span style="color: #008080;"> 11</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.net.URL;
</span><span style="color: #008080;"> 12</span> 
<span style="color: #008080;"> 13</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.content.Context;
</span><span style="color: #008080;"> 14</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Environment;
</span><span style="color: #008080;"> 15</span> 
<span style="color: #008080;"> 16</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.mlxy.util.CharacterProcesser;
</span><span style="color: #008080;"> 17</span> 
<span style="color: #008080;"> 18</span> <span style="color: #008000;">/**</span>
<span style="color: #008080;"> 19</span> <span style="color: #008000;"> * Xml文件下载器，重构完成。
</span><span style="color: #008080;"> 20</span> <span style="color: #008000;"> * 
</span><span style="color: #008080;"> 21</span> <span style="color: #008000;"> * </span><span style="color: #808080;">@author</span><span style="color: #008000;"> mlxy
</span><span style="color: #008080;"> 22</span> <span style="color: #008000;"> * </span><span style="color: #808080;">@version</span><span style="color: #008000;"> 1.1
</span><span style="color: #008080;"> 23</span> <span style="color: #008000;"> * </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 24</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> XmlDownloader {
</span><span style="color: #008080;"> 25</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Context parent;
</span><span style="color: #008080;"> 26</span>     
<span style="color: #008080;"> 27</span>     <span style="color: #0000ff;">private</span> String cityName = "南昌"<span style="color: #000000;">;
</span><span style="color: #008080;"> 28</span>     <span style="color: #0000ff;">private</span> String city =<span style="color: #000000;"> CharacterProcesser.encodeByGB2312(cityName);
</span><span style="color: #008080;"> 29</span>     <span style="color: #0000ff;">private</span> String password = "DJOYnieT8234jlsK"<span style="color: #000000;">;
</span><span style="color: #008080;"> 30</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> day = 0<span style="color: #000000;">;
</span><span style="color: #008080;"> 31</span>     <span style="color: #0000ff;">private</span> String link = "http://php.weather.sina.com.cn/xml.php?city=" +<span style="color: #000000;"> city
</span><span style="color: #008080;"> 32</span>             + "&amp;password=" + password + "&amp;day=" +<span style="color: #000000;"> day;
</span><span style="color: #008080;"> 33</span>     
<span style="color: #008080;"> 34</span>     <span style="color: #008000;">/**</span><span style="color: #008000;"> 私有构造方法，避免被外部实例化。</span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 35</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> XmlDownloader() {
</span><span style="color: #008080;"> 36</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 37</span>     
<span style="color: #008080;"> 38</span>     <span style="color: #008000;">/**</span><span style="color: #008000;"> 根据给定的链接下载对应的xml文件。
</span><span style="color: #008080;"> 39</span> <span style="color: #008000;">     * 
</span><span style="color: #008080;"> 40</span> <span style="color: #008000;">     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> link API的链接，需要标明网络协议。</span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 41</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> downloadXml(String link) {
</span><span style="color: #008080;"> 42</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 用链接字符串new出URL对象</span>
<span style="color: #008080;"> 43</span>         URL url = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 44</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {
</span><span style="color: #008080;"> 45</span>             url = <span style="color: #0000ff;">new</span><span style="color: #000000;"> URL(link);
</span><span style="color: #008080;"> 46</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (MalformedURLException e) {
</span><span style="color: #008080;"> 47</span> <span style="color: #000000;">            e.printStackTrace();
</span><span style="color: #008080;"> 48</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 49</span> 
<span style="color: #008080;"> 50</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 获取外部存储路径并创建文件对象。</span>
<span style="color: #008080;"> 51</span>         File externalDirectory =<span style="color: #000000;"> Environment.getExternalStorageDirectory();
</span><span style="color: #008080;"> 52</span>         String fileName = "xml_resource.xml"<span style="color: #000000;">;
</span><span style="color: #008080;"> 53</span>         File file = <span style="color: #0000ff;">new</span><span style="color: #000000;"> File(externalDirectory, fileName);
</span><span style="color: #008080;"> 54</span> 
<span style="color: #008080;"> 55</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 写文件。
</span><span style="color: #008080;"> 56</span>         
<span style="color: #008080;"> 57</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 初始化io流。</span>
<span style="color: #008080;"> 58</span>         InputStream in = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 59</span>         BufferedReader reader = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 60</span>         FileOutputStream out = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 61</span>         BufferedWriter writer = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 62</span>         
<span style="color: #008080;"> 63</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {
</span><span style="color: #008080;"> 64</span>             
<span style="color: #008080;"> 65</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 建立连接并给io流赋值。</span>
<span style="color: #008080;"> 66</span>             in =<span style="color: #000000;"> (InputStream) url.getContent();
</span><span style="color: #008080;"> 67</span>             reader = <span style="color: #0000ff;">new</span> BufferedReader(<span style="color: #0000ff;">new</span> InputStreamReader(in, "iso-8859-1"<span style="color: #000000;">));
</span><span style="color: #008080;"> 68</span>             out = <span style="color: #0000ff;">this</span><span style="color: #000000;">.parent.openFileOutput(file.getName(), Context.MODE_PRIVATE);
</span><span style="color: #008080;"> 69</span>             writer = <span style="color: #0000ff;">new</span> BufferedWriter(<span style="color: #0000ff;">new</span> OutputStreamWriter(out, "iso-8859-1"<span style="color: #000000;">));
</span><span style="color: #008080;"> 70</span>             
<span style="color: #008080;"> 71</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 读一行写一行，然后另起一行。</span>
<span style="color: #008080;"> 72</span>             String line = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 73</span>             <span style="color: #0000ff;">while</span> ((line = reader.readLine()) != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
</span><span style="color: #008080;"> 74</span> <span style="color: #000000;">                writer.write(line);
</span><span style="color: #008080;"> 75</span> <span style="color: #000000;">                writer.newLine();
</span><span style="color: #008080;"> 76</span> <span style="color: #000000;">            }
</span><span style="color: #008080;"> 77</span>             
<span style="color: #008080;"> 78</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {
</span><span style="color: #008080;"> 79</span> <span style="color: #000000;">            e.printStackTrace();
</span><span style="color: #008080;"> 80</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {
</span><span style="color: #008080;"> 81</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {
</span><span style="color: #008080;"> 82</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 释放资源</span>
<span style="color: #008080;"> 83</span> <span style="color: #000000;">                writer.flush();
</span><span style="color: #008080;"> 84</span> <span style="color: #000000;">                writer.close();
</span><span style="color: #008080;"> 85</span> <span style="color: #000000;">                out.close();
</span><span style="color: #008080;"> 86</span> <span style="color: #000000;">                reader.close();
</span><span style="color: #008080;"> 87</span> <span style="color: #000000;">                in.close();
</span><span style="color: #008080;"> 88</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e2) {
</span><span style="color: #008080;"> 89</span> <span style="color: #000000;">                e2.printStackTrace();
</span><span style="color: #008080;"> 90</span> <span style="color: #000000;">            }
</span><span style="color: #008080;"> 91</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 92</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 93</span>     
<span style="color: #008080;"> 94</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setParent(Context parent) {
</span><span style="color: #008080;"> 95</span>         <span style="color: #0000ff;">this</span>.parent =<span style="color: #000000;"> parent;
</span><span style="color: #008080;"> 96</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 97</span>     
<span style="color: #008080;"> 98</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setCity(String cityName) {
</span><span style="color: #008080;"> 99</span>         <span style="color: #0000ff;">this</span>.cityName =<span style="color: #000000;"> cityName;
</span><span style="color: #008080;">100</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">101</span>     
<span style="color: #008080;">102</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setPassword(String password) {
</span><span style="color: #008080;">103</span>         <span style="color: #0000ff;">this</span>.password =<span style="color: #000000;"> password;
</span><span style="color: #008080;">104</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">105</span>     
<span style="color: #008080;">106</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> setDay(<span style="color: #0000ff;">int</span><span style="color: #000000;"> day) {
</span><span style="color: #008080;">107</span>         <span style="color: #0000ff;">this</span>.day =<span style="color: #000000;"> day;
</span><span style="color: #008080;">108</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">109</span>     
<span style="color: #008080;">110</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> String getLink() {
</span><span style="color: #008080;">111</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">.link;
</span><span style="color: #008080;">112</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">113</span>     
<span style="color: #008080;">114</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> Builder {
</span><span style="color: #008080;">115</span>         <span style="color: #008000;">/**</span><span style="color: #008000;"> 储存好的一个实例，留待建造完毕后返回。</span><span style="color: #008000;">*/</span>
<span style="color: #008080;">116</span>         <span style="color: #0000ff;">private</span> XmlDownloader instance = <span style="color: #0000ff;">new</span><span style="color: #000000;"> XmlDownloader();
</span><span style="color: #008080;">117</span>         
<span style="color: #008080;">118</span>         <span style="color: #008000;">/**</span><span style="color: #008000;"> 构造函数，需要输入启动此构造器的上下文视图作为参数。</span><span style="color: #008000;">*/</span>
<span style="color: #008080;">119</span>         <span style="color: #0000ff;">public</span><span style="color: #000000;"> Builder(Context parent) {
</span><span style="color: #008080;">120</span> <span style="color: #000000;">            instance.setParent(parent);
</span><span style="color: #008080;">121</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">122</span>         
<span style="color: #008080;">123</span>         <span style="color: #008000;">/**</span><span style="color: #008000;"> 设置城市名。&lt;/br&gt;
</span><span style="color: #008080;">124</span> <span style="color: #008000;">         * 默认值为&lt;b&gt;南昌&lt;/b&gt;。
</span><span style="color: #008080;">125</span> <span style="color: #008000;">         * 
</span><span style="color: #008080;">126</span> <span style="color: #008000;">         * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> cityName 城市名
</span><span style="color: #008080;">127</span> <span style="color: #008000;">         * </span><span style="color: #808080;">@return</span><span style="color: #008000;"> 构造器本身
</span><span style="color: #008080;">128</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;">129</span>         <span style="color: #0000ff;">public</span><span style="color: #000000;"> Builder setCity(String cityName) {
</span><span style="color: #008080;">130</span> <span style="color: #000000;">            instance.setCity(cityName);
</span><span style="color: #008080;">131</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;
</span><span style="color: #008080;">132</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">133</span>         
<span style="color: #008080;">134</span>         <span style="color: #008000;">/**</span><span style="color: #008000;"> 设置密码。&lt;/br&gt;
</span><span style="color: #008080;">135</span> <span style="color: #008000;">         * 默认值为&lt;b&gt;DJOYnieT8234jlsK&lt;/b&gt;。
</span><span style="color: #008080;">136</span> <span style="color: #008000;">         * 
</span><span style="color: #008080;">137</span> <span style="color: #008000;">         * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> password API密码
</span><span style="color: #008080;">138</span> <span style="color: #008000;">         * </span><span style="color: #808080;">@return</span><span style="color: #008000;"> 构造器本身
</span><span style="color: #008080;">139</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;">140</span>         <span style="color: #0000ff;">public</span><span style="color: #000000;"> Builder setPassword(String password) {
</span><span style="color: #008080;">141</span> <span style="color: #000000;">            instance.setPassword(password);
</span><span style="color: #008080;">142</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;
</span><span style="color: #008080;">143</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">144</span>         
<span style="color: #008080;">145</span>         <span style="color: #008000;">/**</span><span style="color: #008000;"> 设置日期。&lt;/br&gt;
</span><span style="color: #008080;">146</span> <span style="color: #008000;">         * 默认值为&lt;b&gt;0&lt;/b&gt;，也即是&lt;b&gt;今天&lt;/b&gt;。&lt;/br&gt;
</span><span style="color: #008080;">147</span> <span style="color: #008000;">         * 以此类推。
</span><span style="color: #008080;">148</span> <span style="color: #008000;">         * 
</span><span style="color: #008080;">149</span> <span style="color: #008000;">         * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> day 日子，0为当天，范围在0-4
</span><span style="color: #008080;">150</span> <span style="color: #008000;">         * </span><span style="color: #808080;">@return</span><span style="color: #008000;"> 构造器本身
</span><span style="color: #008080;">151</span>          <span style="color: #008000;">*/</span>
<span style="color: #008080;">152</span>         <span style="color: #0000ff;">public</span> Builder setDay(<span style="color: #0000ff;">int</span><span style="color: #000000;"> day) {
</span><span style="color: #008080;">153</span> <span style="color: #000000;">            instance.setDay(day);
</span><span style="color: #008080;">154</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;
</span><span style="color: #008080;">155</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">156</span>         
<span style="color: #008080;">157</span>         <span style="color: #008000;">/**</span><span style="color: #008000;"> 用已经设置好的或默认的参数下载XML文件。</span><span style="color: #008000;">*/</span>
<span style="color: #008080;">158</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> download() {
</span><span style="color: #008080;">159</span>             String link =<span style="color: #000000;"> instance.getLink();
</span><span style="color: #008080;">160</span> <span style="color: #000000;">            instance.downloadXml(link);
</span><span style="color: #008080;">161</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">162</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">163</span> }</pre>
</div>
<span class="cnblogs_code_collapse">需要结合前面几篇博文看</span></div>
<p>场景类则这么调用：</p>
<div class="cnblogs_code">
<pre><span style="color: #000000;"> 构建Xml下载器并下载Xml文件。
</span><span style="color: #0000ff;">new</span> XmlDownloader.Builder(MainActivity.<span style="color: #0000ff;">this</span><span style="color: #000000;">)
        .setCity(</span>"南昌"<span style="color: #000000;">)
        .setPassword(</span>"DJOYnieT8234jlsK"<span style="color: #000000;">)
        .setDay(</span>0<span style="color: #000000;">)
        .download();</span></pre>
</div>
<p>&nbsp;</p>
<p>具体实现方式参考了安卓的Toast和Dialog等几个类。</p>
<p>&nbsp;</p>
<p>纠结了一天要不要给建造者提供默认值，就是说在用户没有自己设定参数的情况下是直接返回null还是用默认值来处理。</p>
<p>白天一直想着，不能惯用户的毛病。</p>
<p>然后到了晚上，我一想，用户不就是我么，除了我谁还用我写的这个类，就果断用了默认值。</p>
<p>&nbsp;</p>
<p>另外，因为XmlDownloader这个类是不需要实例的，所以：</p>
<p>　　1. 把无参构造函数限制成了私有的，这样别人就没法访问构造函数，也就没法实例化它。</p>
<p>　　2. 去掉了几乎所有getter方法，同时把所有方法和属性定为私有的，因为不会存在任何XmlDownloader对象，也就没有必要对外开放任何接口。</p>
<p>　　2.3.3 求不提反射。</p>
<p>　　3. 要记得给Builder类加上static关键字，因为我们需要通过外部类来直接访问它，如果忘了的话，就会出现这样的一个错误：</p>
<blockquote>
<p>No enclosing instance of type XmlDownloader is accessible. Must qualify the allocation with an enclosing instance of type XmlDownloader (e.g. x.new A() where x is an instance of XmlDownloader).</p>
</blockquote>
<p>&nbsp;</p>
<p>总的来说还是挺好用的，而且也不难，最关键的是</p>
<p><span style="color: #ff0000; font-size: 18pt;">优雅！</span></p>
<p>&nbsp;</p>
<p>用了设计模式之后我整个人都升华了你知道吗</p>

<div align=right><a href="https://github.com/mlxy"><font size=1>——本文由博客园搬家工具SRBCnblogs转换而成</font></a></div>