---

layout: post

title: 空想面霸育成计划

date: 2016-05-31 21:07:00 +0800

categories: Others

tags: [andoid, interview]
---

## 理想的情况

面试官： 说说你这个东西的实现思路吧。

我： 这个最早是项目里要用到的，实际上就是京东那个样式，所以我就是照着京东那个做的。数据虽然是后台给的，但是实际上就是从京东接口扒的。

于是我首先考虑怎么加工这个数据。

他一开始给我的是几个 JSON文件，省市区什么的每个类别一个。其实这个数据量实际上很小，我一直在考虑是不是直接解析字符串也行。但是为了避免出现些不可预料的坑，还是决定用数据库。

当时我正好在研究一个叫 DBFlow 的 ORM 框架，这个库好在它把原生的数据库系统封装过了，操作数据直接链式方法调用就行了——实际上我自从开始用 RxJava，写什么都想把代码写成一串，不过这个是另一回事了，RxJava 的事可能之后再说——然后它建表也是基于实体类的，就像 Gson 那种方式，再加上注解，比如 @Table 什么的，它代码又是用 apt 在编译时生成的，不是用的反射，所以对性能几乎没影响，实体类加注解的方式也更好懂，比常量加 SQL 语句的写法要清晰得多。

我一开始就先简单用 DBFlow 写了个小工具处理原始数据，就是那些 JSON 字符串，把它们按一个类别一张表装到一个 db 文件里，把这个 db 文件放到 assets 文件夹里，就可以随便用了，前面建的实体类也可以继续拿来用。

他这个数据的格式就是一个字符串是名字，就比如北京啊，湖北啊，市级的话就是武汉啊，襄樊什么的，再有一个就是上一级的 ID，比如武汉就保存了一个湖北的 ID，这样我选择湖北之后就可以用湖北的 ID 来查表，选出所有湖北下面的市，再下面的也是以此类推。

所以就按照京东那个控件的逻辑来处理选择的逻辑，控件初始化的时候先选出所有省，把标签设置成请选择。下面显示数据的就是一个 RecyclerView，还是 ListView 的，我也忘了，不过在这用这两个都行，用 ListView 还简单一点。所有级别用的都是一个列表控件，然后为每一个类别创建一个 adapter，切换标签的时候用 setAdapter 装载数据就行了。然后用户选择了一个省之后就把标签文本设置成这个省，同时把这个列表项的视图设置成 disabled，就是把 enable 设置成 false，然后用选择器设成比如 enable 的时候省的文本是黑的，enable 等于 false 的时候是红的，然后右边的对勾一个是对勾，另一个是透明颜色，就可以实现选中效果了。用 enable 状态是因为我假设用户是不需要连续选一样的地址的，比如你一开始选了武汉要选区了，这时候你又点武汉，实际上下面的内容是完全没有变化的，所以干脆就不让他点。这个是 RecyclerView 的情况，如果用的 ListView 用 setSelection 就行了，那个更简单，把状态改成 selected 就行了，不过 setSelection 有一个选中状态颜色不对的坑，要单独处理一下。

选了一级之后就开始加载下一级的数据，如果时间可能比较长的话这里可以先显示一个进度条，等加载完了回调隐藏。数据加载完之后就设置给下一级的 adapter，然后设置给列表，再把下一级的标签显示出来，文本设置成请选择，就跟之前一样了。

一直到某一级它下一级没有数据了，那我就认为已经选完了，就给一个回调，回调方法里有每一级的参数，省市什么的，没有数据的话就直接给空。外面就可以直接拿来用。

如果选到一半想重新选前面的级别，就点哪集把哪集的 adapter 设置给列表，然后把指示器移动到那一级的标签下面。这个指示器因为只用来指示，没有别的用处，就直接用了一个 View，背景设置成红色，一开始宽度是零，控件初始化完成后把宽度设置成第一个标签的宽度。

这里有一个坑，就是直接在构造方法里取宽度是取不到的，是零，因为这个时候各个 View 还没 measure，测量过，所以可以用几种方法，一个是用指示器的 post 方法，这个方法里面传进去的 Runnable 会等到 View 绘制完成后运行，每次设置宽度的时候都用这个办法就没问题了。再一个还可以用一个叫什么 viewTreeObserver 的，它有一个回调方法，这个回调方法执行的时候就可以拿到宽度了。

这个指示器的移动我是用属性动画做的，写一个方法，参数是标签的下标，再把下标写成常量值，比如市的下标是1，可能就写一个 public static int INDEX_CITY = 1，调用的时候用 IntDef 控制传入的值。再在方法里 switch 下标值，比如传的是市的下标，就取市那个标签的宽度和 x 的值，再写两个动画，animator，一个是宽度的变化，用 FastOutSlowInInterceptor 从指示器当前的宽度变到标签的宽度，另一个 animator 用来移动指示器，属性动画可以直接操作 x 的值，最后两个动画组成一个 AnimationSet，一起执行，指示器就一边变大或者变小，一边移动到指定的位置了。用 FastOutSlowInInterceptor 是根据 Material Design 的规范，就是说任何动作都不应该突然启动或者停止，这个指示器移动的过程是发生在屏幕内的，所以它要有一个加速和减速的过程，它开始移动之后慢慢加速，要到地方之后又慢慢减速。这样整个动画看起来比匀速运动要舒服得多，更何况匀速运动也不科学。突然切过去，完全没有动画的情况就更不用说了。

大致上就是这么个情况。

后来我传到 Github 上之后有个人给我提意见，说他在用我这个控件，但是想自定义数据。其实我一开始是想过要支持自定义数据的，但是又考虑到我这个完全是仿京东的，连数据都是京东的，所以只打算给真正就是需要这个样式的人用，也没做支持修改样式的兼容。

但是既然真的有人在用，我之后可能还是会加上扩展，顶多是给一个默认实现吧。而且要做自定义数据也不麻烦，可以用抽象类加抽象方法的方式，让用户自己实现获取数据的方法。或者在构造方法里让他传参数，参数用接口的方式实现获取数据，实际上是一样的思路。

大概就这样。

## 实际可能是

我：…………它代码又是用 apt 在编译时生成的——

面试官：apt 是怎么在编译时生成代码的，原理是什么？

我：…………呃……