---
layout: post
title: 那墙可有五十米高啊！
date: 2015-01-21 09:00:00
categories: cnblogs
---

<p>刚写完用了两天数据源就被封了2333333</p>
<blockquote>
<p>收到通知暂停更新，稍后会删除该文，期待官方解禁。</p>
</blockquote>
<p>&nbsp;</p>
<p>===========================================</p>
<p>&nbsp;</p>
<p>https://github.com/mlxy/GoogleHostsUpdate</p>
<p>简单的读页面源码然后正则匹配。</p>
<p>我只是懒得自己更新hosts。</p>
<p>为了chrome的同步我呕心沥血。</p>
<p>请和之前的汤站爬虫一起加进计划任务里。</p>
<p>&nbsp;</p>
<p>面向过程充满了爱。</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('e43b9d3b-0ffc-42aa-a5ae-652b5d852dde')"><img id="code_img_closed_e43b9d3b-0ffc-42aa-a5ae-652b5d852dde" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_e43b9d3b-0ffc-42aa-a5ae-652b5d852dde" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('e43b9d3b-0ffc-42aa-a5ae-652b5d852dde',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_e43b9d3b-0ffc-42aa-a5ae-652b5d852dde" class="cnblogs_code_hide">
<pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">#</span><span style="color: #008000;">encoding:utf-8</span>
<span style="color: #008080;"> 2</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> urllib
</span><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> re
</span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> os
</span><span style="color: #008080;"> 5</span> 
<span style="color: #008080;"> 6</span> url = <span style="color: #800000;">'</span><span style="color: #800000;">http://www.360kb.com/kb/2_122.html</span><span style="color: #800000;">'</span>
<span style="color: #008080;"> 7</span> regexHosts = r<span style="color: #800000;">'</span><span style="color: #800000;">#google hosts 2015 by 360kb.com.*#google hosts 2015 end</span><span style="color: #800000;">'</span>
<span style="color: #008080;"> 8</span> regexTimeUpdated = r<span style="color: #800000;">'</span><span style="color: #800000;">&lt;strong&gt;(\d\d\d\d\.\d\d?\.\d\d?)&amp;nbsp;&lt;/strong&gt;</span><span style="color: #800000;">'</span>
<span style="color: #008080;"> 9</span> 
<span style="color: #008080;">10</span> hostsPath = <span style="color: #800000;">'</span><span style="color: #800000;">C:\\Windows\\System32\\drivers\\etc\\hosts</span><span style="color: #800000;">'</span>
<span style="color: #008080;">11</span>     
<span style="color: #008080;">12</span> <span style="color: #0000ff;">def</span><span style="color: #000000;"> retrievePage(url):
</span><span style="color: #008080;">13</span>     <span style="color: #800000;">'''</span><span style="color: #800000;"> 读取页面源代码。 </span><span style="color: #800000;">'''</span>
<span style="color: #008080;">14</span>     response =<span style="color: #000000;"> urllib.urlopen(url)
</span><span style="color: #008080;">15</span>     page =<span style="color: #000000;"> response.read()
</span><span style="color: #008080;">16</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> page
</span><span style="color: #008080;">17</span> 
<span style="color: #008080;">18</span> <span style="color: #0000ff;">def</span><span style="color: #000000;"> matchTimeUpdated(page):
</span><span style="color: #008080;">19</span>     <span style="color: #800000;">'''</span><span style="color: #800000;"> 从页面源码中匹配出hosts更新时间。 </span><span style="color: #800000;">'''</span>
<span style="color: #008080;">20</span>     timeUpdated =<span style="color: #000000;"> re.search(regexTimeUpdated, page)
</span><span style="color: #008080;">21</span>     <span style="color: #0000ff;">return</span> timeUpdated.group(1<span style="color: #000000;">)
</span><span style="color: #008080;">22</span> 
<span style="color: #008080;">23</span> <span style="color: #0000ff;">def</span><span style="color: #000000;"> matchHostList(page):
</span><span style="color: #008080;">24</span>     <span style="color: #800000;">'''</span><span style="color: #800000;"> 从页面源码中匹配出host列表。 </span><span style="color: #800000;">'''</span>
<span style="color: #008080;">25</span>     result =<span style="color: #000000;"> re.search(regexHosts, page, re.S)
</span><span style="color: #008080;">26</span>     hosts =<span style="color: #000000;"> result.group()
</span><span style="color: #008080;">27</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> hosts
</span><span style="color: #008080;">28</span>     
<span style="color: #008080;">29</span> <span style="color: #0000ff;">def</span><span style="color: #000000;"> translateSpaceEntity(srcString):
</span><span style="color: #008080;">30</span>     <span style="color: #800000;">'''</span><span style="color: #800000;"> 把结果中的"&amp;nbsp;"转换成空格。 </span><span style="color: #800000;">'''</span>
<span style="color: #008080;">31</span>     <span style="color: #0000ff;">return</span> srcString.replace(<span style="color: #800000;">'</span><span style="color: #800000;">&amp;nbsp;</span><span style="color: #800000;">'</span>, <span style="color: #800000;">'</span> <span style="color: #800000;">'</span><span style="color: #000000;">)
</span><span style="color: #008080;">32</span>     
<span style="color: #008080;">33</span> <span style="color: #0000ff;">def</span><span style="color: #000000;"> removeHtmlLabels(srcString):
</span><span style="color: #008080;">34</span>     <span style="color: #800000;">'''</span><span style="color: #800000;"> 去除结果中的HTML标签。 </span><span style="color: #800000;">'''</span>
<span style="color: #008080;">35</span>     <span style="color: #0000ff;">return</span> re.sub(r<span style="color: #800000;">'</span><span style="color: #800000;">&lt;[^&gt;]+&gt;</span><span style="color: #800000;">'</span>, <span style="color: #800000;">''</span><span style="color: #000000;">, srcString)
</span><span style="color: #008080;">36</span> 
<span style="color: #008080;">37</span> <span style="color: #0000ff;">def</span><span style="color: #000000;"> addExtraInfo(srcString, extraInfo):
</span><span style="color: #008080;">38</span>     <span style="color: #800000;">'''</span><span style="color: #800000;"> 在第一行添加额外信息。</span><span style="color: #800000;">'''</span>
<span style="color: #008080;">39</span>     <span style="color: #0000ff;">return</span> extraInfo + <span style="color: #800000;">'</span><span style="color: #800000;">\n</span><span style="color: #800000;">'</span> +<span style="color: #000000;"> srcString
</span><span style="color: #008080;">40</span> 
<span style="color: #008080;">41</span> <span style="color: #0000ff;">def</span><span style="color: #000000;"> write2File(hosts, filePath):
</span><span style="color: #008080;">42</span>     <span style="color: #800000;">'''</span><span style="color: #800000;"> 写出到文件。 </span><span style="color: #800000;">'''</span>
<span style="color: #008080;">43</span>     f = open(filePath, <span style="color: #800000;">'</span><span style="color: #800000;">w</span><span style="color: #800000;">'</span><span style="color: #000000;">)
</span><span style="color: #008080;">44</span> <span style="color: #000000;">    f.write(hosts)
</span><span style="color: #008080;">45</span> <span style="color: #000000;">    f.close()
</span><span style="color: #008080;">46</span>     
<span style="color: #008080;">47</span> <span style="color: #0000ff;">def</span><span style="color: #000000;"> run():
</span><span style="color: #008080;">48</span>     <span style="color: #800000;">'''</span><span style="color: #800000;"> 主运行函数。 </span><span style="color: #800000;">'''</span>
<span style="color: #008080;">49</span>     page =<span style="color: #000000;"> retrievePage(url)
</span><span style="color: #008080;">50</span>     
<span style="color: #008080;">51</span>     roughHosts =<span style="color: #000000;"> matchHostList(page)
</span><span style="color: #008080;">52</span>     preciseHosts =<span style="color: #000000;"> removeHtmlLabels(translateSpaceEntity(roughHosts))
</span><span style="color: #008080;">53</span>     
<span style="color: #008080;">54</span>     extraInfo = <span style="color: #800000;">'''</span><span style="color: #800000;">#Hosts updated at %s
</span><span style="color: #008080;">55</span> <span style="color: #800000;">#Script written by mlxy@https://github.com/mlxy, feel free to modify and distribute it.
</span><span style="color: #008080;">56</span> <span style="color: #800000;">'''</span> %<span style="color: #000000;">matchTimeUpdated(page)
</span><span style="color: #008080;">57</span>     hostsWithExtra =<span style="color: #000000;"> addExtraInfo(preciseHosts, extraInfo)
</span><span style="color: #008080;">58</span>     
<span style="color: #008080;">59</span> <span style="color: #000000;">    write2File(hostsWithExtra, hostsPath)
</span><span style="color: #008080;">60</span>     
<span style="color: #008080;">61</span> <span style="color: #0000ff;">if</span> <span style="color: #800080;">__name__</span> == <span style="color: #800000;">'</span><span style="color: #800000;">__main__</span><span style="color: #800000;">'</span><span style="color: #000000;">:
</span><span style="color: #008080;">62</span>     run()</pre>
</div>
<span class="cnblogs_code_collapse">而正则表达式则难写的一逼</span></div>
<p>&nbsp;</p>

<div align=right><a href="https://github.com/mlxy/SRBCnblogs"><font size=1>——本文由博客园搬家工具SRBCnblogs转换而成</font></a></div>