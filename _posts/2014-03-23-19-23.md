---
layout: post
title: 终于搞出一个稳定的版本了……
date: 2014-03-23 19:23:00
categories: cnblogs
---

<p>bug大致都清掉了&hellip;&hellip;</p>
<p>至少第一次运行是不会有bug了。</p>
<p>等会看能不能发github上去，然后直接外链到这边吧。</p>
<p>&nbsp;</p>
<p>我花了一个周，就搞出了下载文件这么一个功能&hellip;&hellip;</p>
<p>编程太难玩了。</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('8eb4b42b-81ac-4a6a-a20d-2050264b0a20')"><img id="code_img_closed_8eb4b42b-81ac-4a6a-a20d-2050264b0a20" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_8eb4b42b-81ac-4a6a-a20d-2050264b0a20" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('8eb4b42b-81ac-4a6a-a20d-2050264b0a20',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_8eb4b42b-81ac-4a6a-a20d-2050264b0a20" class="cnblogs_code_hide">
<pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.mlxy.xml;
</span><span style="color: #008080;">  2</span> 
<span style="color: #008080;">  3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.BufferedReader;
</span><span style="color: #008080;">  4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.BufferedWriter;
</span><span style="color: #008080;">  5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.File;
</span><span style="color: #008080;">  6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.FileOutputStream;
</span><span style="color: #008080;">  7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.InputStream;
</span><span style="color: #008080;">  8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.InputStreamReader;
</span><span style="color: #008080;">  9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.OutputStreamWriter;
</span><span style="color: #008080;"> 10</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.net.MalformedURLException;
</span><span style="color: #008080;"> 11</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.net.URL;
</span><span style="color: #008080;"> 12</span> 
<span style="color: #008080;"> 13</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.content.Context;
</span><span style="color: #008080;"> 14</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Environment;
</span><span style="color: #008080;"> 15</span> 
<span style="color: #008080;"> 16</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.mlxy.util.CharacterProcesser;
</span><span style="color: #008080;"> 17</span> 
<span style="color: #008080;"> 18</span> <span style="color: #008000;">/**</span> 
<span style="color: #008080;"> 19</span> <span style="color: #008000;"> * XML文件下载器。
</span><span style="color: #008080;"> 20</span> <span style="color: #008000;"> * 
</span><span style="color: #008080;"> 21</span> <span style="color: #008000;"> * </span><span style="color: #808080;">@author</span><span style="color: #008000;"> mlxy
</span><span style="color: #008080;"> 22</span> <span style="color: #008000;"> * </span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 23</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> XmlDownloader {
</span><span style="color: #008080;"> 24</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Context parent;
</span><span style="color: #008080;"> 25</span>     
<span style="color: #008080;"> 26</span>     <span style="color: #0000ff;">private</span> String city = CharacterProcesser.encodeByGB2312("南昌"<span style="color: #000000;">);
</span><span style="color: #008080;"> 27</span>     <span style="color: #0000ff;">private</span> String password = "DJOYnieT8234jlsK"<span style="color: #000000;">;
</span><span style="color: #008080;"> 28</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> day = 0<span style="color: #000000;">;
</span><span style="color: #008080;"> 29</span>     <span style="color: #0000ff;">private</span> String link = "http://php.weather.sina.com.cn/xml.php?city=" +<span style="color: #000000;"> city
</span><span style="color: #008080;"> 30</span>             + "&amp;password=" + password + "&amp;day=" +<span style="color: #000000;"> day;
</span><span style="color: #008080;"> 31</span>     
<span style="color: #008080;"> 32</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> XmlDownloader(Context parent) {
</span><span style="color: #008080;"> 33</span>         <span style="color: #0000ff;">this</span>.parent =<span style="color: #000000;"> parent;
</span><span style="color: #008080;"> 34</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 35</span>     
<span style="color: #008080;"> 36</span>     <span style="color: #008000;">/**</span><span style="color: #008000;"> 外部接口，根据设置好的类属性下载xml文件。</span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 37</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> download() {
</span><span style="color: #008080;"> 38</span>         downloadAndVerifyXml(<span style="color: #0000ff;">this</span><span style="color: #000000;">.link);
</span><span style="color: #008080;"> 39</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 40</span>     
<span style="color: #008080;"> 41</span>     <span style="color: #008000;">/**</span><span style="color: #008000;"> 根据给定的链接下载对应的xml文件。
</span><span style="color: #008080;"> 42</span> <span style="color: #008000;">     * 
</span><span style="color: #008080;"> 43</span> <span style="color: #008000;">     * </span><span style="color: #808080;">@param</span><span style="color: #008000;"> link API的链接，需要标明网络协议。</span><span style="color: #008000;">*/</span>
<span style="color: #008080;"> 44</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> downloadAndVerifyXml(String link) {
</span><span style="color: #008080;"> 45</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 用链接字符串new出URL对象</span>
<span style="color: #008080;"> 46</span>         URL url = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 47</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {
</span><span style="color: #008080;"> 48</span>             url = <span style="color: #0000ff;">new</span><span style="color: #000000;"> URL(link);
</span><span style="color: #008080;"> 49</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (MalformedURLException e) {
</span><span style="color: #008080;"> 50</span> <span style="color: #000000;">            e.printStackTrace();
</span><span style="color: #008080;"> 51</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 52</span> 
<span style="color: #008080;"> 53</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 获取外部存储路径并创建文件对象。</span>
<span style="color: #008080;"> 54</span>         File externalDirectory =<span style="color: #000000;"> Environment.getExternalStorageDirectory();
</span><span style="color: #008080;"> 55</span>         String fileName = "xml_resource.xml"<span style="color: #000000;">;
</span><span style="color: #008080;"> 56</span>         File file = <span style="color: #0000ff;">new</span><span style="color: #000000;"> File(externalDirectory, fileName);
</span><span style="color: #008080;"> 57</span> 
<span style="color: #008080;"> 58</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 写文件。
</span><span style="color: #008080;"> 59</span>         
<span style="color: #008080;"> 60</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 初始化io流。</span>
<span style="color: #008080;"> 61</span>         InputStream in = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 62</span>         BufferedReader reader = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 63</span>         FileOutputStream out = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 64</span>         BufferedWriter writer = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 65</span>         
<span style="color: #008080;"> 66</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {
</span><span style="color: #008080;"> 67</span>             
<span style="color: #008080;"> 68</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 建立连接并给io流赋值。</span>
<span style="color: #008080;"> 69</span>             in =<span style="color: #000000;"> (InputStream) url.getContent();
</span><span style="color: #008080;"> 70</span>             reader = <span style="color: #0000ff;">new</span> BufferedReader(<span style="color: #0000ff;">new</span> InputStreamReader(in, "iso-8859-1"<span style="color: #000000;">));
</span><span style="color: #008080;"> 71</span>             out = <span style="color: #0000ff;">this</span><span style="color: #000000;">.parent.openFileOutput(file.getName(), Context.MODE_PRIVATE);
</span><span style="color: #008080;"> 72</span>             writer = <span style="color: #0000ff;">new</span> BufferedWriter(<span style="color: #0000ff;">new</span> OutputStreamWriter(out, "iso-8859-1"<span style="color: #000000;">));
</span><span style="color: #008080;"> 73</span>             
<span style="color: #008080;"> 74</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 读一行写一行，然后另起一行。</span>
<span style="color: #008080;"> 75</span>             String line = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 76</span>             <span style="color: #0000ff;">while</span> ((line = reader.readLine()) != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
</span><span style="color: #008080;"> 77</span> <span style="color: #000000;">                writer.write(line);
</span><span style="color: #008080;"> 78</span> <span style="color: #000000;">                writer.newLine();
</span><span style="color: #008080;"> 79</span> <span style="color: #000000;">            }
</span><span style="color: #008080;"> 80</span>             
<span style="color: #008080;"> 81</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {
</span><span style="color: #008080;"> 82</span> <span style="color: #000000;">            e.printStackTrace();
</span><span style="color: #008080;"> 83</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {
</span><span style="color: #008080;"> 84</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {
</span><span style="color: #008080;"> 85</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 释放资源</span>
<span style="color: #008080;"> 86</span> <span style="color: #000000;">                writer.flush();
</span><span style="color: #008080;"> 87</span> <span style="color: #000000;">                writer.close();
</span><span style="color: #008080;"> 88</span> <span style="color: #000000;">                out.close();
</span><span style="color: #008080;"> 89</span> <span style="color: #000000;">                reader.close();
</span><span style="color: #008080;"> 90</span> <span style="color: #000000;">                in.close();
</span><span style="color: #008080;"> 91</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e2) {
</span><span style="color: #008080;"> 92</span> <span style="color: #000000;">                e2.printStackTrace();
</span><span style="color: #008080;"> 93</span> <span style="color: #000000;">            }
</span><span style="color: #008080;"> 94</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 95</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 96</span>     
<span style="color: #008080;"> 97</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> XmlDownloader setCity(String city) {
</span><span style="color: #008080;"> 98</span>         <span style="color: #0000ff;">this</span>.city =<span style="color: #000000;"> city;
</span><span style="color: #008080;"> 99</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;
</span><span style="color: #008080;">100</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">101</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> String getCity() {
</span><span style="color: #008080;">102</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">.city;
</span><span style="color: #008080;">103</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">104</span>     
<span style="color: #008080;">105</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> XmlDownloader setPassword(String password) {
</span><span style="color: #008080;">106</span>         <span style="color: #0000ff;">this</span>.password =<span style="color: #000000;"> password;
</span><span style="color: #008080;">107</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;
</span><span style="color: #008080;">108</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">109</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> String getPassword() {
</span><span style="color: #008080;">110</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">.password;
</span><span style="color: #008080;">111</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">112</span>     
<span style="color: #008080;">113</span>     <span style="color: #0000ff;">public</span> XmlDownloader setDay(<span style="color: #0000ff;">int</span><span style="color: #000000;"> day) {
</span><span style="color: #008080;">114</span>         <span style="color: #0000ff;">this</span>.day =<span style="color: #000000;"> day;
</span><span style="color: #008080;">115</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;
</span><span style="color: #008080;">116</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">117</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> getDay() {
</span><span style="color: #008080;">118</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">.day;
</span><span style="color: #008080;">119</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">120</span>     
<span style="color: #008080;">121</span>     <span style="color: #008000;">/**</span><span style="color: #008000;"> 获取API链接。</span><span style="color: #008000;">*/</span>
<span style="color: #008080;">122</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> String getLink() {
</span><span style="color: #008080;">123</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">.link;
</span><span style="color: #008080;">124</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">125</span> }</pre>
</div>
<span class="cnblogs_code_collapse">目前就这样</span></div>
<p>&nbsp;</p>

<p align=right><span style="font-size: 12px">——本文由博客园搬家工具<a href="https://github.com/mlxy/SRBCnblogs">SRBCnblogs</a>转换而成</span></p>