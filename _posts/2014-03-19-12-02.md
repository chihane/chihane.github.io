---
layout: post
title: 都过了半年了，又被字符编码搞了
date: 2014-03-19 12:02:00
categories: cnblogs
---

<div class="cnblogs_code" onclick="cnblogs_code_show('32294280-5027-4d68-82df-3bc81cbb581a')"><img id="code_img_closed_32294280-5027-4d68-82df-3bc81cbb581a" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_32294280-5027-4d68-82df-3bc81cbb581a" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('32294280-5027-4d68-82df-3bc81cbb581a',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_32294280-5027-4d68-82df-3bc81cbb581a" class="cnblogs_code_hide">
<pre><span style="color: #008080;"> 1</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> getXmlSource(String link) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> IOException {
</span><span style="color: #008080;"> 2</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 用链接字符串new出URL对象</span>
<span style="color: #008080;"> 3</span>         URL url = <span style="color: #0000ff;">new</span><span style="color: #000000;"> URL(link);
</span><span style="color: #008080;"> 4</span> 
<span style="color: #008080;"> 5</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 输入输出流</span>
<span style="color: #008080;"> 6</span>         InputStream in =<span style="color: #000000;"> (InputStream) url.getContent();
</span><span style="color: #008080;"> 7</span>         BufferedReader reader = <span style="color: #0000ff;">new</span> BufferedReader(<span style="color: #0000ff;">new</span> InputStreamReader(in, "UTF-8"<span style="color: #000000;">));
</span><span style="color: #008080;"> 8</span>         FileOutputStream out = <span style="color: #0000ff;">new</span> FileOutputStream("xml_resource.xml"<span style="color: #000000;">);
</span><span style="color: #008080;"> 9</span>         OutputStreamWriter writer = <span style="color: #0000ff;">new</span> OutputStreamWriter(out, "UTF-8"<span style="color: #000000;">);
</span><span style="color: #008080;">10</span> 
<span style="color: #008080;">11</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 读一行写一行</span>
<span style="color: #008080;">12</span>         String line = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
</span><span style="color: #008080;">13</span>         <span style="color: #0000ff;">while</span> ((line = reader.readLine()) != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
</span><span style="color: #008080;">14</span> <span style="color: #000000;">            writer.write(line);;
</span><span style="color: #008080;">15</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">16</span> 
<span style="color: #008080;">17</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 释放资源</span>
<span style="color: #008080;">18</span> <span style="color: #000000;">        writer.close();
</span><span style="color: #008080;">19</span> <span style="color: #000000;">        out.close();
</span><span style="color: #008080;">20</span> <span style="color: #000000;">        reader.close();
</span><span style="color: #008080;">21</span> <span style="color: #000000;">        in.close();
</span><span style="color: #008080;">22</span> 
<span style="color: #008080;">23</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 打印成功信息</span>
<span style="color: #008080;">24</span>         System.out.println("OK"<span style="color: #000000;">);
</span><span style="color: #008080;">25</span>     }</pre>
</div>
<span class="cnblogs_code_collapse">先发结果</span></div>
<p>&nbsp;作用是把指定URL连接到的XML文件下载下来。</p>
<p>一开始是全部乱码，我感觉大概是因为资源是UTF-8的，然后输出的不是，于是百度了一下，想把输出的内容先按UTF-8解码再输出，百度到的方法是用字符串的getBytes()方法把字符串转成字节数组，然后重新new一个字符串，用重载的构造方法加上编码类型作为参数，但是出现了很奇怪的情况，输出的文件里大部分显示正常了，但是有一部分内容是乱码，而且乱码的部分也不是生僻字也不是特殊符号的，这样想找办法都无从找起，于是只好另想办法。</p>
<p>&nbsp;</p>
<p>后来发现构造输入流InputStreamReader的时候是可以加上编码作为参数的，一下子觉得找到办法了，于是果断按UTF-8来输入，然后原样输出，不行。</p>
<p>用上面的办法编码成GBK输出，不行。</p>
<p>编成UTF-8，不行。</p>
<p>症状是输出txt显示完全正常，但是输出成xml的话打开会报错，直接编辑会发现里面还是乱码。</p>
<p>&nbsp;</p>
<p>最后就放弃了，上S1问了一下，没想到马上就有答案了&hellip;&hellip;</p>
<blockquote>
<p>输出文件不要用FileWriter，这样的话你输出的编码跟本机的OS和语言有关，用OutputStreamWriter输出，指定UTF-8编码</p>
</blockquote>
<blockquote>
<p>java的读写都要指定字符集, 不然默认都是操作系统的字符集来着.. <br /><br />
在java里所有string都是用utf8存的, 只有转为byte串的时候才会转为相应的编码. 所以读取时候指定的字符集只决定了java用什么编码把byte[]转为string, 不影响你读取后存在内存里的string是什么字符集</p>
</blockquote>
<p>结果问题出在细节上&hellip;&hellip;</p>
<p>于是马上改了改代码，一下就成功了。</p>
<p>输入输出流都是可以指定字符集的，总之跟编码打交道的时候就不要偷懒用FileWriter了&hellip;&hellip;</p>

<p align=right><span style="font-size: 12px">——本文由博客园搬家工具<a href="https://github.com/mlxy/SRBCnblogs">SRBCnblogs</a>转换而成</span></p>