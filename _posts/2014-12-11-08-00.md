---
layout: post
title: 支持单选的PreferenceCategory和单选项Preference
date: 2014-12-11 08:00:00
categories: cnblogs
---

<p>目前还有很多问题，趁还没忘的时候先记下来，之后再慢慢改。</p>
<p>&nbsp;</p>
<p>先发代码：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('982479ed-cd42-4b41-b1c5-31bae0ed449f')"><img id="code_img_closed_982479ed-cd42-4b41-b1c5-31bae0ed449f" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_982479ed-cd42-4b41-b1c5-31bae0ed449f" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('982479ed-cd42-4b41-b1c5-31bae0ed449f',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_982479ed-cd42-4b41-b1c5-31bae0ed449f" class="cnblogs_code_hide">
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> RadioPreferenceCategory <span style="color: #0000ff;">extends</span> PreferenceCategory <span style="color: #0000ff;">implements</span><span style="color: #000000;"> OnPreferenceChangeListener {
</span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">public</span> RadioPreferenceCategory(Context context, AttributeSet attrs, <span style="color: #0000ff;">int</span><span style="color: #000000;"> defStyle) {
</span><span style="color: #008080;"> 3</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context, attrs, defStyle);
</span><span style="color: #008080;"> 4</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 5</span> 
<span style="color: #008080;"> 6</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> RadioPreferenceCategory(Context context, AttributeSet attrs) {
</span><span style="color: #008080;"> 7</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context, attrs);
</span><span style="color: #008080;"> 8</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 9</span> 
<span style="color: #008080;">10</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> RadioPreferenceCategory(Context context) {
</span><span style="color: #008080;">11</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context);
</span><span style="color: #008080;">12</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">13</span> 
<span style="color: #008080;">14</span> <span style="color: #000000;">    @Override
</span><span style="color: #008080;">15</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> onPrepareAddPreference(Preference preference) {
</span><span style="color: #008080;">16</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 监听单选框的变化。</span>
<span style="color: #008080;">17</span>         preference.setOnPreferenceChangeListener(<span style="color: #0000ff;">this</span><span style="color: #000000;">);
</span><span style="color: #008080;">18</span> 
<span style="color: #008080;">19</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">super</span><span style="color: #000000;">.onPrepareAddPreference(preference);
</span><span style="color: #008080;">20</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">21</span>     
<span style="color: #008080;">22</span> <span style="color: #000000;">    @Override
</span><span style="color: #008080;">23</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> onPreferenceChange(Preference preference, Object newValue) {
</span><span style="color: #008080;">24</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> RadioButton的状态。</span>
<span style="color: #008080;">25</span>         <span style="color: #0000ff;">boolean</span> isChecked =<span style="color: #000000;"> (Boolean) newValue;
</span><span style="color: #008080;">26</span>         
<span style="color: #008080;">27</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;"> (isChecked) {
</span><span style="color: #008080;">28</span> <span style="color: #000000;">            onRadioChecked((RadioPreference) preference);
</span><span style="color: #008080;">29</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;
</span><span style="color: #008080;">30</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">31</span>         
<span style="color: #008080;">32</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">;
</span><span style="color: #008080;">33</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">34</span>     
<span style="color: #008080;">35</span>     <span style="color: #008000;">/**</span><span style="color: #008000;"> 一项选中时取消其他所有。</span><span style="color: #008000;">*/</span>
<span style="color: #008080;">36</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onRadioChecked(RadioPreference checkedRadioPreference) {
</span><span style="color: #008080;">37</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 没选中的话按理说不会执行到这个方法。</span>
<span style="color: #008080;">38</span>         <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">checkedRadioPreference.isChecked()) {
</span><span style="color: #008080;">39</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;
</span><span style="color: #008080;">40</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">41</span>         
<span style="color: #008080;">42</span>         String checkedKey =<span style="color: #000000;"> checkedRadioPreference.getKey();
</span><span style="color: #008080;">43</span>         
<span style="color: #008080;">44</span>         <span style="color: #0000ff;">int</span> count =<span style="color: #000000;"> getPreferenceCount();
</span><span style="color: #008080;">45</span>         <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = 0; i &lt; count; i++<span style="color: #000000;">) {
</span><span style="color: #008080;">46</span>             RadioPreference preference =<span style="color: #000000;"> (RadioPreference) getPreference(i);
</span><span style="color: #008080;">47</span>             String key =<span style="color: #000000;"> preference.getKey();
</span><span style="color: #008080;">48</span>             
<span style="color: #008080;">49</span>             <span style="color: #0000ff;">if</span> (key !=<span style="color: #000000;"> checkedKey) {
</span><span style="color: #008080;">50</span>                 preference.setChecked(<span style="color: #0000ff;">false</span><span style="color: #000000;">);
</span><span style="color: #008080;">51</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">52</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">53</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">54</span> }</pre>
</div>
<span class="cnblogs_code_collapse">RadioPreferenceCategory</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('f55493eb-8492-47d8-9c45-081662cbcc3b')"><img id="code_img_closed_f55493eb-8492-47d8-9c45-081662cbcc3b" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_f55493eb-8492-47d8-9c45-081662cbcc3b" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('f55493eb-8492-47d8-9c45-081662cbcc3b',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_f55493eb-8492-47d8-9c45-081662cbcc3b" class="cnblogs_code_hide">
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> RadioPreference <span style="color: #0000ff;">extends</span> Preference <span style="color: #0000ff;">implements</span><span style="color: #000000;"> OnCheckedChangeListener {
</span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> RadioButton radioButton;
</span><span style="color: #008080;"> 3</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> isChecked;
</span><span style="color: #008080;"> 4</span> 
<span style="color: #008080;"> 5</span>     <span style="color: #0000ff;">public</span> RadioPreference(Context context, AttributeSet attrs, <span style="color: #0000ff;">int</span><span style="color: #000000;"> defStyle) {
</span><span style="color: #008080;"> 6</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context, attrs, defStyle);
</span><span style="color: #008080;"> 7</span> <span style="color: #000000;">        setLayoutResource(R.layout.radio_preference);
</span><span style="color: #008080;"> 8</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 9</span> 
<span style="color: #008080;">10</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> RadioPreference(Context context, AttributeSet attrs) {
</span><span style="color: #008080;">11</span>         <span style="color: #0000ff;">this</span>(context, attrs, 0<span style="color: #000000;">);
</span><span style="color: #008080;">12</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">13</span> 
<span style="color: #008080;">14</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> RadioPreference(Context context) {
</span><span style="color: #008080;">15</span>         <span style="color: #0000ff;">this</span>(context, <span style="color: #0000ff;">null</span><span style="color: #000000;">);
</span><span style="color: #008080;">16</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">17</span>     
<span style="color: #008080;">18</span> <span style="color: #000000;">    @Override
</span><span style="color: #008080;">19</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onBindView(View view) {
</span><span style="color: #008080;">20</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onBindView(view);
</span><span style="color: #008080;">21</span>         
<span style="color: #008080;">22</span>         radioButton =<span style="color: #000000;"> (RadioButton) view.findViewById(R.id.radio);
</span><span style="color: #008080;">23</span>         radioButton.setOnCheckedChangeListener(<span style="color: #0000ff;">this</span><span style="color: #000000;">);
</span><span style="color: #008080;">24</span> <span style="color: #000000;">        radioButton.setChecked(isChecked);
</span><span style="color: #008080;">25</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">26</span>     
<span style="color: #008080;">27</span> <span style="color: #000000;">    @Override
</span><span style="color: #008080;">28</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onCheckedChanged(CompoundButton buttonView, <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> isChecked) {
</span><span style="color: #008080;">29</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;"> (isChecked) {
</span><span style="color: #008080;">30</span> <span style="color: #000000;">            setChecked(isChecked);
</span><span style="color: #008080;">31</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">32</span>         
<span style="color: #008080;">33</span> <span style="color: #000000;">        callChangeListener(isChecked);
</span><span style="color: #008080;">34</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">35</span> 
<span style="color: #008080;">36</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> isChecked() {
</span><span style="color: #008080;">37</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> radioButton.isChecked();
</span><span style="color: #008080;">38</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">39</span> 
<span style="color: #008080;">40</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> setChecked(<span style="color: #0000ff;">boolean</span><span style="color: #000000;"> checked) {
</span><span style="color: #008080;">41</span>         isChecked =<span style="color: #000000;"> checked;
</span><span style="color: #008080;">42</span> <span style="color: #000000;">        radioButton.setChecked(checked);
</span><span style="color: #008080;">43</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">44</span> }</pre>
</div>
<span class="cnblogs_code_collapse">RadioPreference</span></div>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>每次都会调用bindview所以要在里面赋值所以要把状态暂时保存起来。</p>
<p>setcheck时保存，persist什么的</p>
<p>twostatePreference是API14以后的所以不能直接用而且&nbsp;&nbsp; boolean newValue = !isChecked();就是来回切换，而radiobutton不能</p>
<p>必须有key&nbsp;配合布局</p>
<p>onclick不知道为啥不好使</p>
<p>setLayoutResource设置默认布局</p>

<div align=right><a href="https://github.com/mlxy/SRBCnblogs"><font size=1>——本文由博客园搬家工具SRBCnblogs转换而成</font></a></div>