---
layout: post
title: 前年的斐波那契蹲在地上看着你，笑而不语
date: 2015-04-11 04:21:00
categories: cnblogs
---

<p>我之前那个更新hosts的脚本啊。</p>
<p>匹配的是开头的注释和结尾的注释。</p>
<p>然后那个站主没事总改注释。</p>
<p>结果我那个脚本动不动就失效。</p>
<p>然后我就得改正则重新提交。</p>
<p>改多了我就烦了。</p>
<p>就懒得更新hosts了。</p>
<p>今儿个我心情好。</p>
<p>打开脚本一看。</p>
<p>我他娘的为什么不直接匹配hosts内容？</p>
<p>为他娘的什么？</p>
<p>啊？</p>
<p>你敢睁大狗眼看看</p>
<blockquote>
<pre>119.161.83.27    google.com</pre>
</blockquote>
<p>吗？</p>
<p>一个IP，一个换行符。</p>
<p>啊？</p>
<p>啊？</p>
<p>要注释有个卵用？</p>
<p>啊？</p>
<div class="cnblogs_code">
<pre>r<span style="color: #800000;">'</span><span style="color: #800000;">(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3} [^\n]+)\n</span><span style="color: #800000;">'</span></pre>
</div>
<p>啊？？</p>
<p>&nbsp;</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('baf493ae-ad57-40ce-b2b1-38749ededd97')"><img id="code_img_closed_baf493ae-ad57-40ce-b2b1-38749ededd97" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_baf493ae-ad57-40ce-b2b1-38749ededd97" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('baf493ae-ad57-40ce-b2b1-38749ededd97',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_baf493ae-ad57-40ce-b2b1-38749ededd97" class="cnblogs_code_hide">
<pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">#</span><span style="color: #008000;">encoding:utf-8</span>
<span style="color: #008080;"> 2</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> urllib
</span><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> re
</span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> os
</span><span style="color: #008080;"> 5</span> 
<span style="color: #008080;"> 6</span> url = <span style="color: #800000;">'</span><span style="color: #800000;">http://www.360kb.com/kb/2_122.html</span><span style="color: #800000;">'</span>
<span style="color: #008080;"> 7</span> regexHosts = r<span style="color: #800000;">'</span><span style="color: #800000;">(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3} [^\n]+)\n</span><span style="color: #800000;">'</span>
<span style="color: #008080;"> 8</span> regexTimeUpdated = r<span style="color: #800000;">'</span><span style="color: #800000;">google hosts (\d\d\d\d\.\d\d?\.\d\d?)</span><span style="color: #800000;">'</span>
<span style="color: #008080;"> 9</span> 
<span style="color: #008080;">10</span> hostsPath = <span style="color: #800000;">'</span><span style="color: #800000;">C:\\Windows\\System32\\drivers\\etc\\hosts</span><span style="color: #800000;">'</span>
<span style="color: #008080;">11</span>     
<span style="color: #008080;">12</span> <span style="color: #0000ff;">def</span><span style="color: #000000;"> retrievePage(url):
</span><span style="color: #008080;">13</span>     <span style="color: #800000;">'''</span><span style="color: #800000;"> 读取页面源代码。 </span><span style="color: #800000;">'''</span>
<span style="color: #008080;">14</span>     response =<span style="color: #000000;"> urllib.urlopen(url)
</span><span style="color: #008080;">15</span>     page =<span style="color: #000000;"> response.read()
</span><span style="color: #008080;">16</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> page
</span><span style="color: #008080;">17</span> 
<span style="color: #008080;">18</span> <span style="color: #0000ff;">def</span><span style="color: #000000;"> matchTimeUpdated(page):
</span><span style="color: #008080;">19</span>     <span style="color: #800000;">'''</span><span style="color: #800000;"> 从页面源码中匹配出hosts更新时间。 </span><span style="color: #800000;">'''</span>
<span style="color: #008080;">20</span>     timeUpdated =<span style="color: #000000;"> re.search(regexTimeUpdated, page)
</span><span style="color: #008080;">21</span>     <span style="color: #0000ff;">if</span> <span style="color: #0000ff;">not</span><span style="color: #000000;"> timeUpdated:
</span><span style="color: #008080;">22</span>         <span style="color: #0000ff;">return</span> <span style="color: #800000;">'</span><span style="color: #800000;">unknown time</span><span style="color: #800000;">'</span>
<span style="color: #008080;">23</span>     <span style="color: #0000ff;">else</span><span style="color: #000000;">:
</span><span style="color: #008080;">24</span>         <span style="color: #0000ff;">return</span> timeUpdated.group(1<span style="color: #000000;">)
</span><span style="color: #008080;">25</span> 
<span style="color: #008080;">26</span> <span style="color: #0000ff;">def</span><span style="color: #000000;"> matchHostList(page):
</span><span style="color: #008080;">27</span>     <span style="color: #800000;">'''</span><span style="color: #800000;"> 从页面源码中匹配出host列表。 </span><span style="color: #800000;">'''</span>
<span style="color: #008080;">28</span>     result =<span style="color: #000000;"> re.findall(regexHosts, page, re.S)
</span><span style="color: #008080;">29</span>     
<span style="color: #008080;">30</span>     <span style="color: #0000ff;">if</span> <span style="color: #0000ff;">not</span><span style="color: #000000;"> result:
</span><span style="color: #008080;">31</span>         <span style="color: #0000ff;">return</span> <span style="color: #800000;">'</span><span style="color: #800000;">#Hosts update failed.\n#May resolved by update the script.</span><span style="color: #800000;">'</span>
<span style="color: #008080;">32</span>     <span style="color: #0000ff;">else</span><span style="color: #000000;">:
</span><span style="color: #008080;">33</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> result
</span><span style="color: #008080;">34</span> 
<span style="color: #008080;">35</span> <span style="color: #0000ff;">def</span><span style="color: #000000;"> concatenateHosts(hosts):
</span><span style="color: #008080;">36</span>     <span style="color: #800000;">'''</span><span style="color: #800000;"> 把列表拼接成字符串。 </span><span style="color: #800000;">'''</span>
<span style="color: #008080;">37</span>     <span style="color: #0000ff;">return</span> <span style="color: #800000;">'</span><span style="color: #800000;">\n</span><span style="color: #800000;">'</span><span style="color: #000000;">.join(hosts)
</span><span style="color: #008080;">38</span> 
<span style="color: #008080;">39</span> <span style="color: #0000ff;">def</span><span style="color: #000000;"> addExtraInfo(srcString, extraInfo):
</span><span style="color: #008080;">40</span>     <span style="color: #800000;">'''</span><span style="color: #800000;"> 在第一行添加额外信息。</span><span style="color: #800000;">'''</span>
<span style="color: #008080;">41</span>     <span style="color: #0000ff;">return</span> extraInfo + <span style="color: #800000;">'</span><span style="color: #800000;">\n</span><span style="color: #800000;">'</span> +<span style="color: #000000;"> srcString
</span><span style="color: #008080;">42</span> 
<span style="color: #008080;">43</span> <span style="color: #0000ff;">def</span><span style="color: #000000;"> write2File(hosts, filePath):
</span><span style="color: #008080;">44</span>     <span style="color: #800000;">'''</span><span style="color: #800000;"> 写出到文件。 </span><span style="color: #800000;">'''</span>
<span style="color: #008080;">45</span>     f = open(filePath, <span style="color: #800000;">'</span><span style="color: #800000;">w</span><span style="color: #800000;">'</span><span style="color: #000000;">)
</span><span style="color: #008080;">46</span> <span style="color: #000000;">    f.write(hosts)
</span><span style="color: #008080;">47</span> <span style="color: #000000;">    f.close()
</span><span style="color: #008080;">48</span>     
<span style="color: #008080;">49</span> <span style="color: #0000ff;">def</span><span style="color: #000000;"> run():
</span><span style="color: #008080;">50</span>     <span style="color: #800000;">'''</span><span style="color: #800000;"> 主运行函数。 </span><span style="color: #800000;">'''</span>
<span style="color: #008080;">51</span>     page =<span style="color: #000000;"> retrievePage(url)
</span><span style="color: #008080;">52</span>     
<span style="color: #008080;">53</span>     hosts =<span style="color: #000000;"> matchHostList(page)
</span><span style="color: #008080;">54</span>     
<span style="color: #008080;">55</span>     extraInfo = <span style="color: #800000;">'''</span><span style="color: #800000;">#Hosts updated at %s
</span><span style="color: #008080;">56</span> <span style="color: #800000;">#Script written by mlxy@https://github.com/mlxy, feel free to modify and distribute it.
</span><span style="color: #008080;">57</span> <span style="color: #800000;">'''</span> %<span style="color: #000000;">matchTimeUpdated(page)
</span><span style="color: #008080;">58</span>     hostsWithExtra =<span style="color: #000000;"> addExtraInfo(concatenateHosts(hosts), extraInfo)
</span><span style="color: #008080;">59</span>    
<span style="color: #008080;">60</span> <span style="color: #000000;">    write2File(hostsWithExtra, hostsPath)
</span><span style="color: #008080;">61</span>     
<span style="color: #008080;">62</span> <span style="color: #0000ff;">if</span> <span style="color: #800080;">__name__</span> == <span style="color: #800000;">'</span><span style="color: #800000;">__main__</span><span style="color: #800000;">'</span><span style="color: #000000;">:
</span><span style="color: #008080;">63</span> <span style="color: #000000;">    run()
</span><span style="color: #008080;">64</span>     <span style="color: #0000ff;">print</span> <span style="color: #800000;">'</span><span style="color: #800000;">Finished.</span><span style="color: #800000;">'</span></pre>
</div>
<span class="cnblogs_code_collapse">啊？？？</span></div>
<p><a href="https://github.com/mlxy/GoogleHostsUpdate" target="_blank">啊？</a></p>

<div align=right><a href="https://github.com/mlxy/SRBCnblogs"><font size=1>——本文由博客园搬家工具SRBCnblogs转换而成</font></a></div>